<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-56382716-11","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="alternate" type="application/rss+xml" href="/kb/rss.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kb/atom.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world Atom Feed"><title data-rh="true">Use Rook Ceph External Storage with Harvester | The open-source hyperconverged infrastructure solution for a cloud-native world</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://harvesterhci.io/kb/use_rook_ceph_external_storage"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Use Rook Ceph External Storage with Harvester | The open-source hyperconverged infrastructure solution for a cloud-native world"><meta data-rh="true" name="description" content="Use Rook Ceph External Storage with Harvester"><meta data-rh="true" property="og:description" content="Use Rook Ceph External Storage with Harvester"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-08-23T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/futuretea"><meta data-rh="true" property="article:tag" content="harvester,rook,ceph,csi"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://harvesterhci.io/kb/use_rook_ceph_external_storage"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/use_rook_ceph_external_storage" hreflang="en"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/use_rook_ceph_external_storage" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2a831778.css">
<link rel="preload" href="/assets/js/runtime~main.0c08fa38.js" as="script">
<link rel="preload" href="/assets/js/main.2aa1bfff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://docs.harvesterhci.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__docs"><span>Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.suse.com/c/?s=harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__blog"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a aria-current="page" class="navbar__item navbar__link navbar__kb navbar__link--active" href="/kb">Knowledge Base</a><a href="https://github.com/harvester/harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">More from SUSE</a><ul class="dropdown__menu"><li><a href="https://www.rancher.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__rancher"><span>Rancher<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://elemental.docs.rancher.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__elemental"><span>Elemental<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://fleet.rancher.io/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__fleet"><span>Fleet<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://opensource.suse.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__suse"><span>More Projects...<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">All Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/kubevirt_certificates_rotation">KubeVirt Certificates Rotation</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/harvester_security_best_practices">Best Practices for Harvester Security</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/renew_harvester_cloud_credentials">Renew Harvester Cloud Credentials</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/install_iscsi_firmware_install_boot">Configuring Harvester to Boot from an iSCSI Root Disk in Special Circumstances</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/the_potential_risk_with_filesystem_trim">Mitigating filesystem trim Risk</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/calculation_of_resource_metrics_in_harvester">Calculation of Resource Metrics in Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/best_practices_for_optimizing_longhorn_disk_performance">Best Practices for Optimizing Longhorn Disk Performance</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm_live_migration_policy_and_configuration">VM Live Migration Policy and Configuration</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/kb/use_rook_ceph_external_storage">Use Rook Ceph External Storage with Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/install_netapp_trident_csi">Using NetApp Storage on Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/configure_priority_class_longhorn">Configure PriorityClass on Longhorn System Components</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/package_your_own_toolbox_image">Package your own Toolbox Image</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/scan-and-repair-vm-root-filesystem">Scan and Repair Root Filesystem of VirtualMachine</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/evicting-replicas-from-a-disk-the-cli-way">Evicting Replicas From a Disk (the CLI way)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/nic-naming-scheme">NIC Naming Scheme</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/multiple-nics-vm-connectivity">Multiple NICs VM Connectivity</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm-scheduling">VM Scheduling</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Use Rook Ceph External Storage with Harvester</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-08-23T00:00:00.000Z" itemprop="datePublished">August 23, 2023</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/futuretea" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/futuretea.png" alt="Hang Yu"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/futuretea" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Hang Yu</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Starting with Harvester v1.2.0, it offers the capability to install a Container Storage Interface (CSI) in your Harvester cluster. This allows you to leverage external storage for the Virtual Machine&#x27;s non-system data disk, giving you the flexibility to use different drivers tailored for specific needs, whether it&#x27;s for performance optimization or seamless integration with your existing in-house storage solutions.</p><p>It&#x27;s important to note that, despite this enhancement, the provisioner for the Virtual Machine (VM) image in Harvester still relies on Longhorn. Prior to version 1.2.0, Harvester exclusively supported Longhorn for storing VM data and did not offer support for external storage as a destination for VM data.</p><p>One of the options for integrating external storage with Harvester is Rook, an open-source cloud-native storage orchestrator. Rook provides a robust platform, framework, and support for Ceph storage, enabling seamless integration with cloud-native environments.</p><p><a href="https://ceph.io" target="_blank" rel="noopener noreferrer">Ceph</a> is a software-defined distributed storage system that offers versatile storage capabilities, including file, block, and object storage. It is designed for large-scale production clusters and can be deployed effectively in such environments.</p><p><a href="https://rook.io" target="_blank" rel="noopener noreferrer">Rook</a> simplifies the deployment and management of Ceph, offering self-managing, self-scaling, and self-healing storage services. It leverages Kubernetes resources to automate the deployment, configuration, provisioning, scaling, upgrading, and monitoring of Ceph.</p><p>In this article, we will walk you through the process of installing, configuring, and utilizing <a href="https://rook.io/docs/rook/v1.12/Getting-Started/intro/" target="_blank" rel="noopener noreferrer">Rook</a> to use storage from an <a href="https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/" target="_blank" rel="noopener noreferrer">existing external Ceph cluster</a> as a data disk for a VM within the Harvester environment.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-harvester-cluster">Install Harvester Cluster<a class="hash-link" href="#install-harvester-cluster" title="Direct link to heading">​</a></h2><p>Harvester&#x27;s operating system follows an immutable design, meaning that most OS files revert to their pre-configured state after a reboot. To accommodate Rook Ceph&#x27;s requirements, you need to add specific persistent paths to the <code>os.persistentStatePaths</code> section in the <a href="https://docs.harvesterhci.io/dev/install/harvester-configuration#ospersistent_state_paths" target="_blank" rel="noopener noreferrer">Harvester configuration</a>. These paths include:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">os</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">persistent_state_paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/lib/rook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/lib/ceph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">modules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> rbd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nbd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After the cluster is installed, refer to <a href="https://docs.harvesterhci.io/v1.1/faq#how-can-i-access-the-kubeconfig-file-of-the-harvester-cluster" target="_blank" rel="noopener noreferrer">How can I access the kubeconfig file of the Harvester cluster?</a> to get the kubeconfig of the Harvester cluster.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-rook-to-harvester">Install Rook to Harvester<a class="hash-link" href="#install-rook-to-harvester" title="Direct link to heading">​</a></h2><p>Install Rook to the Harvester cluster by referring to <a href="https://rook.io/docs/rook/v1.12/Getting-Started/quickstart/" target="_blank" rel="noopener noreferrer">Rook Quickstart</a>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -fsSLo rook.tar.gz https://github.com/rook/rook/archive/refs/tags/v1.12.2.tar.gz </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -zxf rook.tar.gz </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> rook-1.12.2/deploy/examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># apply configurations ref: https://rook.github.io/docs/rook/v1.12/Getting-Started/example-configurations/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f crds.yaml -f common.yaml -f operator.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n rook-ceph </span><span class="token function" style="color:#d73a49">wait</span><span class="token plain"> --for</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Available deploy rook-ceph-operator --timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">10m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="using-an-existing-external-ceph-cluster">Using an existing external Ceph cluster<a class="hash-link" href="#using-an-existing-external-ceph-cluster" title="Direct link to heading">​</a></h2><ol><li>Run the python script <code>create-external-cluster-resources.py</code> in the <a href="https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/" target="_blank" rel="noopener noreferrer">existing external Ceph cluster</a> for creating all users and keys.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># script help ref: https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/#1-create-all-users-and-keys</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -s https://raw.githubusercontent.com/rook/rook/v1.12.2/deploy/examples/create-external-cluster-resources.py </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> create-external-cluster-resources.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 create-external-cluster-resources.py --rbd-data-pool-name </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pool_name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --namespace rook-ceph-external --format </span><span class="token function" style="color:#d73a49">bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="2"><li>Copy the Bash output.</li></ol><p>Example output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export NAMESPACE=rook-ceph-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_FSID=b3b47828-4c60-11ee-be38-51902f85c805</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_USERNAME=client.healthchecker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_CEPH_MON_DATA=ceph-1=192.168.5.99:6789</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_USER_SECRET=AQDd6/dkFyu/IhAATv/uCMbHtWk4AYK2KXzBhQ==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_DASHBOARD_LINK=https://192.168.5.99:8443/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_NODE_SECRET=AQDd6/dk2HsjIxAA06Yw9UcOg0dfwV/9IFBRhA==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_NODE_SECRET_NAME=csi-rbd-node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_PROVISIONER_SECRET=AQDd6/dkEY1kIxAAAzrXZnVRf4x+wDUz1zyaQg==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_PROVISIONER_SECRET_NAME=csi-rbd-provisioner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MONITORING_ENDPOINT=192.168.5.99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MONITORING_ENDPOINT_PORT=9283</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RBD_POOL_NAME=test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RGW_POOL_PREFIX=default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="3"><li>Consume the external Ceph cluster resources on the Harvester cluster.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Paste the above output from create-external-cluster-resources.py into import-env.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> import-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> import-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># this script will create a StorageClass ceph-rbd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> import-external-cluster.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f common-external.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f cluster-external.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># wait for all pods to become Ready</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">watch</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;kubectl --namespace rook-ceph get pods&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="4"><li>Create the VolumeSnapshotClass <code>csi-rbdplugin-snapclass-external</code>.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">./csi/rbd/snapshotclass-external.yaml </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: snapshot.storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: VolumeSnapshotClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: csi-rbdplugin-snapclass-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">driver: rook-ceph.rbd.csi.ceph.com # driver:namespace:operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  clusterID: rook-ceph-external # namespace:cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  csi.storage.k8s.io/snapshotter-secret-name: rook-csi-rbd-provisioner</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  csi.storage.k8s.io/snapshotter-secret-namespace: rook-ceph-external # namespace:cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">deletionPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ./csi/rbd/snapshotclass-external.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="configure-harvester-cluster">Configure Harvester Cluster<a class="hash-link" href="#configure-harvester-cluster" title="Direct link to heading">​</a></h2><p>Before you can make use of Harvester&#x27;s <strong>Backup &amp; Snapshot</strong> features, you need to set up some essential configurations through the Harvester <a href="https://docs.harvesterhci.io/v1.2/advanced/settings#csi-driver-config" target="_blank" rel="noopener noreferrer">csi-driver-config</a> setting. To set up these configurations, follow these steps:</p><ol><li>Login to the Harvester UI, then navigate to <strong>Advanced</strong> &gt; <strong>Settings</strong>.</li><li>Find and select <strong>csi-driver-config</strong>, and then click on the <strong>⋮</strong> &gt; <strong>Edit Setting</strong> to access the configuration options.</li><li>In the settings, set the <strong>Provisioner</strong> to <code>rook-ceph.rbd.csi.ceph.com</code>.</li><li>Next, specify the <strong>Volume Snapshot Class Name</strong> as <code>csi-rbdplugin-snapclass-external</code>. This setting points to the name of the <code>VolumeSnapshotClass</code> used for creating volume snapshots or VM snapshots.</li><li>Similarly, set the <strong>Backup Volume Snapshot Class Name</strong> to <code>csi-rbdplugin-snapclass-external</code>. This corresponds to the name of the <code>VolumeSnapshotClass</code> responsible for creating VM backups.</li></ol><p><img loading="lazy" alt="csi-driver-config-external" src="/assets/images/csi-driver-config-external-59b885aff7095a9bda897ed59f289d82.png" width="3824" height="1848"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="use-rook-ceph-in-harvester">Use Rook Ceph in Harvester<a class="hash-link" href="#use-rook-ceph-in-harvester" title="Direct link to heading">​</a></h2><p>After successfully configuring these settings, you can proceed to utilize the Rook Ceph StorageClass, which is named <code>rook-ceph-block</code> for the internal Ceph cluster or named <code>ceph-rbd</code> for the external Ceph cluster. You can apply this StorageClass when creating an empty volume or adding a new block volume to a VM, enhancing your Harvester cluster&#x27;s storage capabilities.</p><p>With these configurations in place, your Harvester cluster is ready to make the most of the Rook Ceph storage integration.</p><p><img loading="lazy" alt="rook-ceph-volume-external" src="/assets/images/rook-ceph-volume-external-974d73b9b863e95495c7b119d2c50954.png" width="3824" height="1848"></p><p><img loading="lazy" alt="rook-ceph-vm-external" src="/assets/images/rook-ceph-vm-external-4c1b4f6b6a6676e13d312cac3498d786.png" width="3824" height="1848"></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/rook">rook</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/ceph">ceph</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/csi">csi</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/harvester/harvesterhci.io/edit/main/kb/2023-08-23/using_rook_ceph_storage.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kb/vm_live_migration_policy_and_configuration"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">VM Live Migration Policy and Configuration</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#install-harvester-cluster" class="table-of-contents__link toc-highlight">Install Harvester Cluster</a></li><li><a href="#install-rook-to-harvester" class="table-of-contents__link toc-highlight">Install Rook to Harvester</a></li><li><a href="#using-an-existing-external-ceph-cluster" class="table-of-contents__link toc-highlight">Using an existing external Ceph cluster</a></li><li><a href="#configure-harvester-cluster" class="table-of-contents__link toc-highlight">Configure Harvester Cluster</a></li><li><a href="#use-rook-ceph-in-harvester" class="table-of-contents__link toc-highlight">Use Rook Ceph in Harvester</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 harvesterhci.io</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0c08fa38.js"></script>
<script src="/assets/js/main.2aa1bfff.js"></script>
</body>
</html>