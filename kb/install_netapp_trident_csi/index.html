<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-56382716-11","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="alternate" type="application/rss+xml" href="/kb/rss.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kb/atom.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world Atom Feed"><title data-rh="true">Using NetApp Storage on Harvester | The open-source hyperconverged infrastructure solution for a cloud-native world</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://harvesterhci.io/kb/install_netapp_trident_csi"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Using NetApp Storage on Harvester | The open-source hyperconverged infrastructure solution for a cloud-native world"><meta data-rh="true" name="description" content="Installation procedure for NetApp Astra Trident CSI Driver"><meta data-rh="true" property="og:description" content="Installation procedure for NetApp Astra Trident CSI Driver"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-08-11T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="harvester"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://harvesterhci.io/kb/install_netapp_trident_csi"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/install_netapp_trident_csi" hreflang="en"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/install_netapp_trident_csi" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2a831778.css">
<link rel="preload" href="/assets/js/runtime~main.0c08fa38.js" as="script">
<link rel="preload" href="/assets/js/main.2aa1bfff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://docs.harvesterhci.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__docs"><span>Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.suse.com/c/?s=harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__blog"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a aria-current="page" class="navbar__item navbar__link navbar__kb navbar__link--active" href="/kb">Knowledge Base</a><a href="https://github.com/harvester/harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">More from SUSE</a><ul class="dropdown__menu"><li><a href="https://www.rancher.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__rancher"><span>Rancher<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://elemental.docs.rancher.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__elemental"><span>Elemental<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://fleet.rancher.io/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__fleet"><span>Fleet<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://opensource.suse.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__suse"><span>More Projects...<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">All Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/kubevirt_certificates_rotation">KubeVirt Certificates Rotation</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/harvester_security_best_practices">Best Practices for Harvester Security</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/renew_harvester_cloud_credentials">Renew Harvester Cloud Credentials</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/install_iscsi_firmware_install_boot">Configuring Harvester to Boot from an iSCSI Root Disk in Special Circumstances</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/the_potential_risk_with_filesystem_trim">Mitigating filesystem trim Risk</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/calculation_of_resource_metrics_in_harvester">Calculation of Resource Metrics in Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/best_practices_for_optimizing_longhorn_disk_performance">Best Practices for Optimizing Longhorn Disk Performance</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm_live_migration_policy_and_configuration">VM Live Migration Policy and Configuration</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/use_rook_ceph_external_storage">Use Rook Ceph External Storage with Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/kb/install_netapp_trident_csi">Using NetApp Storage on Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/configure_priority_class_longhorn">Configure PriorityClass on Longhorn System Components</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/package_your_own_toolbox_image">Package your own Toolbox Image</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/scan-and-repair-vm-root-filesystem">Scan and Repair Root Filesystem of VirtualMachine</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/evicting-replicas-from-a-disk-the-cli-way">Evicting Replicas From a Disk (the CLI way)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/nic-naming-scheme">NIC Naming Scheme</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/multiple-nics-vm-connectivity">Multiple NICs VM Connectivity</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm-scheduling">VM Scheduling</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Using NetApp Storage on Harvester</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-08-11T00:00:00.000Z" itemprop="datePublished">August 11, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Jeff Radick</span></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>This article covers instructions for installing the Netapp Astra Trident CSI driver into a Harvester cluster, which enables NetApp storage systems to store storage volumes usable by virtual machines running in Harvester.</p><p>The NetApp storage will be an option in addition to the normal Longhorn storage; it will not replace Longhorn. Virtual machine images will still be stored using Longhorn.</p><p>This has been tested with Harvester 1.2.0 and Trident v23.07.0.</p><p>This procedure only works to access storage via iSCSI, not NFS.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>3rd party storage classes (including those based on Trident) can only be used for non-boot volumes of Harvester VMs.</p></div></div><h1>Detailed Instructions</h1><p>We assume that before beginning this procedure, a Harvester cluster and a NetApp ONTAP storage system are both installed and configured for use.</p><p>Most of these steps can be performed on any system with the <code>helm</code> and <code>kubectl</code> commands installed and network connectivity to the management port of the Harvester cluster.  Let&#x27;s call this your workstation.  Certain steps must be performed on one or more cluster nodes themselves.  The steps described below should be done on your workstation unless otherwise indicated.</p><p>The last step (enabling multipathd) should be done on all nodes after the Trident CSI has been installed.</p><p>Certain parameters of your installation will require modification of details in the examples in the procedure given below. Those which you may wish to modify include:</p><ul><li>The namespace.  <code>trident</code> is used as the namespace in the examples, but you may prefer to use another.</li><li>The name of the deployment. <code>mytrident</code> is used but you can change this to something else.</li><li>The management IP address of the ONTAP storage system</li><li>Login credentials (username and password) of the ONTAP storage system</li></ul><p>The procedure is as follows.</p><ol><li><p>Read the NetApp Astra Trident documentation:</p><ul><li><a href="https://docs.netapp.com/us-en/trident/" target="_blank" rel="noopener noreferrer">https://docs.netapp.com/us-en/trident/</a></li><li><a href="https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-operator.html" target="_blank" rel="noopener noreferrer">https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-operator.html</a></li><li><a href="https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-helm.html#deploy-the-trident-operator-and-install-astra-trident-using-helm" target="_blank" rel="noopener noreferrer">https://docs.netapp.com/us-en/trident/trident-get-started/kubernetes-deploy-helm.html#deploy-the-trident-operator-and-install-astra-trident-using-helm</a></li></ul><p>The simplest method is to install using Helm; that process is described here.</p></li><li><p>Download the KubeConfig from the Harvester cluster.</p><ul><li>Open the web UI for your Harvester cluster</li><li>In the lower left corner, click the &quot;Support&quot; link.  This will take you to a &quot;Harvester Support&quot; page.</li><li>Click the button labeled &quot;Download KubeConfig&quot;.  This will download a your cluster config in a file called &quot;local.yaml&quot; by default.</li><li>Move this file to a convenient location and set your <code>KUBECONFIG</code> environment variable to the path of this file.</li></ul></li><li><p>Prepare the cluster for installation of the Helm chart.</p><p>Before starting installation of the helm chart, special authorization must be provided to enable certain modifications to be made during the installation.
This addresses the issue described here: <a href="https://github.com/NetApp/trident/issues/839" target="_blank" rel="noopener noreferrer">https://github.com/NetApp/trident/issues/839</a></p><ul><li><p>Put the following text into a file.  For this example we&#x27;ll call it <code>authorize_trident.yaml</code>.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">psa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> management.cattle.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> projects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> updatepsa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">psa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">psa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Apply this manifest via the command <code>kubectl apply -f authorize_trident.yaml</code>.</p></li></ul></li><li><p>Install the helm chart.</p><ul><li><p>First you will need to add the Astra Trident Helm repository:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> netapp-trident https://netapp.github.io/trident-helm-chart</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Next, install the Helm chart.  This example uses <code>mytrident</code> as the deployment name, <code>trident</code> as the namespace, and 23.07.0 as the version number to install:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> mytrident netapp-trident/trident-operator --version </span><span class="token number" style="color:#36acaa">23.07</span><span class="token plain">.0 --create-namespace --namespace trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>The NetApp documentation describes variations on how you can do this.</p></li></ul></li><li><p>Download and extract the tridentctl command, which will be needed for the next few steps.</p><p>This and the next few steps need to be performed logged into a master node of the Harvester cluster, using root access.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -L -o trident-installer-23.07.0.tar.gz https://github.com/NetApp/trident/releases/download/v23.07.0/trident-installer-23.07.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -xf trident-installer-23.07.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> trident-installer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Install a backend.</p><p>This part is specific to Harvester.</p><ol><li><p>Put the following into a text file, for example /tmp/backend.yaml</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">backendName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default_backend_san</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">storageDriverName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ontap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">san</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">economy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">managementLIF</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 172.19.97.114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">svm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default_backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> password1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default_backend_san</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The LIF IP address, username, and password of this file
should be replaced with the management LIF and credentials
for the ONTAP system.</p></li><li><p>Create the backend</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./tridentctl create backend -f /tmp/backend.yaml -n trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Check that it is created</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./tridentctl get backend -n trident</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></li><li><p>Define a StorageClass and SnapshotClass.</p><ol><li><p>Put the following into a file, for example <code>/tmp/storage.yaml</code></p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> StorageClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ontap</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">san</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">economy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">provisioner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> csi.trident.netapp.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;name=default_backend_san&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> snapshot.storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VolumeSnapshotClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> csi</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">snapclass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">driver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> csi.trident.netapp.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">deletionPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Apply the definitions:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f /tmp/storage.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ol></li><li><p>Enable multipathd</p><p>The following is required to enable multipathd.
This must be done on every node of the Harvester cluster, using root access.
The preceding steps should only be done once on a single node.</p><ol><li><p>Create this file in <code>/oem/99_multipathd.yaml</code>:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">stages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Setup multipathd&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">systemctl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token key atrule" style="color:#00a4db">enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> multipathd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token key atrule" style="color:#00a4db">start</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> multipathd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Configure <code>multipathd</code> to exclude pathnames used by Longhorn.</p><p>This part is a little tricky.  <code>multipathd</code> will automatically discover
device names matching a certain pattern, and attempt to set up multipathing on them.
Unfortunately, Longhorn&#x27;s device names follow the same pattern, and
will not work correctly if <code>multipathd</code> tries to use those devices.</p><p>Therefore the file <code>/etc/multipath.conf</code> must be set up on each node
so as to prevent <code>multipathd</code> from touching any of the devices
that Longhorn will use.  Unfortunately, it is not possible to know
in advance which device names will be used until the volumes are attached
to a VM when the VM is started, or when the volumes are hot-added to a running VM.
The recommended method is to &quot;whitelist&quot; the Trident devices using device
properties rather than device naming.  The properties to allow are the
device vendor and product.  Here is an example of what you&#x27;ll want in <code>/etc/multipath.conf</code>:</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx text"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">blacklist {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vendor &quot;!NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        product &quot;!LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blacklist_exceptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vendor &quot;NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        product &quot;LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> This example only works if NetApp is the only storage provider in the system for which <code>multipathd</code> must be used.  More complex environments will require more complex configuration.</p><p> Explicitly putting that content into <code>/etc/multipath.conf</code> will work when you start <code>multipathd</code> as described below, but the change in <code>/etc</code> will not persist across node reboots.  To solve that problem, you should add another file to <code>/oem</code> that will re-generate <code>/etc/multipath.conf</code> when the node reboots.  The following example will create the <code>/etc/multipath.conf</code> given in the example above, but may need to be modified for your environment if you have a more complex iSCSI configuration:</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx text"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">stages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   initramfs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - name: &quot;Configure multipath blacklist and whitelist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       files:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       - path: /etc/multipath.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         permissions: 0644</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         owner: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         group: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         content: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           blacklist {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   vendor &quot;!NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   product &quot;!LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            blacklist_exceptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                device {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    vendor &quot;NETAPP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    product &quot;LUN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> Remember, this has to be done on every node.</p></li><li><p>Enable multipathd.</p><p>Adding the above files to <code>/oem</code> will take effect on the next reboot of the node; <code>multipathd</code> can be enabled immediately without rebooting the node using the following commands:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> multipathd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start multipathd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>  After the above steps, the <code>ontap-san-economy</code> storage class should be available when creating a volume for a Harvester VM.</p></li></ol></li></ol></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/harvester/harvesterhci.io/edit/main/kb/2023-08-11/using_netapp_third_party_storage.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kb/configure_priority_class_longhorn"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Configure PriorityClass on Longhorn System Components</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 harvesterhci.io</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0c08fa38.js"></script>
<script src="/assets/js/main.2aa1bfff.js"></script>
</body>
</html>