<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-56382716-11","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="alternate" type="application/rss+xml" href="/kb/rss.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kb/atom.xml" title="The open-source hyperconverged infrastructure solution for a cloud-native world Atom Feed"><title data-rh="true">13 posts tagged with &quot;harvester&quot; | The open-source hyperconverged infrastructure solution for a cloud-native world</title><meta data-rh="true" property="og:title" content="13 posts tagged with &quot;harvester&quot; | The open-source hyperconverged infrastructure solution for a cloud-native world"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://harvesterhci.io/kb/tags/harvester"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://harvesterhci.io/kb/tags/harvester"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/tags/harvester" hreflang="en"><link data-rh="true" rel="alternate" href="https://harvesterhci.io/kb/tags/harvester" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2a831778.css">
<link rel="preload" href="/assets/js/runtime~main.0c08fa38.js" as="script">
<link rel="preload" href="/assets/js/main.2aa1bfff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_horizontal.svg" alt="Harvester Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://docs.harvesterhci.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__docs"><span>Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.suse.com/c/?s=harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__blog"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a aria-current="page" class="navbar__item navbar__link navbar__kb navbar__link--active" href="/kb">Knowledge Base</a><a href="https://github.com/harvester/harvester" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">More from SUSE</a><ul class="dropdown__menu"><li><a href="https://www.rancher.com" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__rancher"><span>Rancher<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://elemental.docs.rancher.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__elemental"><span>Elemental<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://fleet.rancher.io/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__fleet"><span>Fleet<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://opensource.suse.com/" target="_blank" rel="noopener noreferrer" class="dropdown__link navbar__icon navbar__suse"><span>More Projects...<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">All Posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/kubevirt_certificates_rotation">KubeVirt Certificates Rotation</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/harvester_security_best_practices">Best Practices for Harvester Security</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/renew_harvester_cloud_credentials">Renew Harvester Cloud Credentials</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/install_iscsi_firmware_install_boot">Configuring Harvester to Boot from an iSCSI Root Disk in Special Circumstances</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/the_potential_risk_with_filesystem_trim">Mitigating filesystem trim Risk</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/calculation_of_resource_metrics_in_harvester">Calculation of Resource Metrics in Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/best_practices_for_optimizing_longhorn_disk_performance">Best Practices for Optimizing Longhorn Disk Performance</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm_live_migration_policy_and_configuration">VM Live Migration Policy and Configuration</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/use_rook_ceph_external_storage">Use Rook Ceph External Storage with Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/install_netapp_trident_csi">Using NetApp Storage on Harvester</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/configure_priority_class_longhorn">Configure PriorityClass on Longhorn System Components</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/package_your_own_toolbox_image">Package your own Toolbox Image</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/scan-and-repair-vm-root-filesystem">Scan and Repair Root Filesystem of VirtualMachine</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/evicting-replicas-from-a-disk-the-cli-way">Evicting Replicas From a Disk (the CLI way)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/nic-naming-scheme">NIC Naming Scheme</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/multiple-nics-vm-connectivity">Multiple NICs VM Connectivity</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/kb/vm-scheduling">VM Scheduling</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>13 posts tagged with &quot;harvester&quot;</h1><a href="/kb/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/kubevirt_certificates_rotation">KubeVirt Certificates Rotation</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-11-28T00:00:00.000Z" itemprop="datePublished">November 28, 2024</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/brandboat" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/brandboat.png" alt="Cooper Tseng"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/brandboat" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Cooper Tseng</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Harvester&#x27;s embedded Rancher UI may display warnings about expiring KubeVirt certificates. You can safely ignore these warnings because automatic certificate rotation is handled by KubeVirt and is enabled by default.</p><p><img loading="lazy" alt="kubevirt-certs-expired" src="/assets/images/kubevirt_certs_expired-af496d05bad47614e7fb644c8971950d.png" width="1716" height="937"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="kubevirt-certificate-rotation-strategy">KubeVirt Certificate Rotation Strategy<a class="hash-link" href="#kubevirt-certificate-rotation-strategy" title="Direct link to heading">​</a></h2><p>KubeVirt provides a self-signed certificate mechanism that rotates both CA and certifcates on a defined recurring interval. You can check the setting  <code>certificateRotateStrategy</code> by running the following command:</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get kubevirt -n harvester-system -o yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>By default, the value of <code>certificateRotateStrategy</code> is empty, which means that KubeVirt uses its default rotation settings and no manual configuration is required.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">certificateRotateStrategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuration-fields">Configuration Fields<a class="hash-link" href="#configuration-fields" title="Direct link to heading">​</a></h2><p>You can use the following fields to configure <code>certificateRotateStrategy</code>.</p><ul><li><code>.ca.duration</code>: Validity period of the CA certificate. The default value is &quot;168h&quot;.</li><li><code>.ca.renewBefore</code>: Amount of time before a CA certificate expires during which a new certificate is issued. The default value is &quot;33.6h&quot;.</li><li><code>.server.duration</code>: Validity period of server component certificates (for example, virt-api, virt-handler, and virt-operator). The default value is &quot;24h&quot;.</li><li><code>.server.renewBefore</code>: Amount of time before a server certificate expires during which a new certificate is issued. The default value is &quot;4.8h&quot;.</li></ul><p>Example of a complete configuration:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">certificateRotateStrategy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selfSigned</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ca</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">duration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 168h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">renewBefore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 33.6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">duration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 24h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">renewBefore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 4.8h</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="certificate-rotation-triggers">Certificate Rotation Triggers<a class="hash-link" href="#certificate-rotation-triggers" title="Direct link to heading">​</a></h2><p>Certificate rotation can be triggered by several conditions. The following list only outlines key triggers and is not exhaustive.</p><ul><li>Missing certificate: A required certificate does not exist.</li><li>Invalid CA signature: A certificate was not signed by the specified CA.</li><li>Proactive renewal: The <code>renewBefore</code> value takes effect. A new certificate must be issued before the current one expires.</li><li>CA expiration: The CA certificate has expired, so the certificate signed by the CA is also rotated.</li></ul><p>When certificate rotation is triggered, you should see <code>virt-operator</code> log records similar to the following:</p><div class="codeBlockContainer_I0IT language-txt theme-code-block"><div class="codeBlockContent_wNvx txt"><pre tabindex="0" class="prism-code language-txt codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-virt-api-certs updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:02:01.045809Z&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-controller-certs updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:02:01.056759Z&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-exportproxy-certs updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:02:01.063530Z&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-virt-handler-server-certs updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:02:01.068608Z&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-virt-handler-certs updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:02:01.074555Z&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-operator-certs updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:02:01.078719Z&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-export-ca updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:03:36.063496Z&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;component&quot;:&quot;virt-operator&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;secret kubevirt-ca updated&quot;,&quot;pos&quot;:&quot;core.go:278&quot;,&quot;timestamp&quot;:&quot;2024-12-06T08:04:06.052750Z&quot;}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">​</a></h2><ul><li>Harvester: <a href="https://github.com/harvester/harvester/issues/5798" target="_blank" rel="noopener noreferrer">Issue 5798</a></li><li><a href="https://kubevirt.io/2020/KubeVirt-Security-Fundamentals.html" target="_blank" rel="noopener noreferrer">https://kubevirt.io/2020/KubeVirt-Security-Fundamentals.html</a></li><li><a href="https://github.com/kubevirt/kubevirt/blob/v1.1.1/pkg/virt-operator/resource/generate/components/secrets.go#L326" target="_blank" rel="noopener noreferrer">https://github.com/kubevirt/kubevirt/blob/v1.1.1/pkg/virt-operator/resource/generate/components/secrets.go#L326</a></li><li><a href="https://github.com/kubevirt/kubevirt/blob/v1.1.1/pkg/virt-operator/resource/apply/certificates.go" target="_blank" rel="noopener noreferrer">https://github.com/kubevirt/kubevirt/blob/v1.1.1/pkg/virt-operator/resource/apply/certificates.go</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/kubevirt">kubevirt</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/certificates">certificates</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/cert">cert</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/ca">ca</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about KubeVirt Certificates Rotation" href="/kb/kubevirt_certificates_rotation"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/harvester_security_best_practices">Best Practices for Harvester Security</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-05-31T00:00:00.000Z" itemprop="datePublished">May 31, 2024</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/w13915984028.png" alt="Jian Wang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jian Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="user-provided-credentials-on-harvester">User-Provided Credentials on Harvester<a class="hash-link" href="#user-provided-credentials-on-harvester" title="Direct link to heading">​</a></h2><p>When <a href="https://docs.harvesterhci.io/v1.2/install/index#installation-steps" target="_blank" rel="noopener noreferrer">installing a Harvester cluster</a>, you are asked to provide the following credential related information:</p><ul><li><p>Cluster token of the first node that is added to the cluster. Other nodes must use this token to join the cluster.</p></li><li><p>Password for the default Linux user <code>rancher</code> on each node.</p></li><li><p>SSH keys on each node (optional).</p></li><li><p>HTTP proxy on each node (optional).</p></li></ul><p>You may plan to change them from time to time, the following paragraphs describe the detailed steps.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cluster-token">Cluster Token<a class="hash-link" href="#cluster-token" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="cluster-token-on-nodes-joining-an-existing-cluster">Cluster Token on Nodes Joining an Existing Cluster<a class="hash-link" href="#cluster-token-on-nodes-joining-an-existing-cluster" title="Direct link to heading">​</a></h4><p>When a node is unable to join a cluster because of a cluster token error, perform the recommended <a href="https://docs.harvesterhci.io/v1.2/troubleshooting/index/#modifying-cluster-token-on-agent-nodes" target="_blank" rel="noopener noreferrer">troubleshooting steps</a>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="cluster-token-rke2-token-rotation">Cluster Token (RKE2 Token Rotation)<a class="hash-link" href="#cluster-token-rke2-token-rotation" title="Direct link to heading">​</a></h4><p>Harvester does not allow you to change the cluster token even if RKE2 is a core component of Harvester.</p><p>The <a href="https://docs.rke2.io/security/token#server-token-rotation" target="_blank" rel="noopener noreferrer">RKE2 documentation</a> states that the November 2023 releases of RKE2 (v1.28.3+rke2r2, v1.27.7+rke2r2, v1.26.10+rke2r2, and v1.25.15+rke2r2) allow you to rotate the cluster token using the command <code>rke2 token rotate --token original --new-token new</code>. </p><p>During testing, the command was run on the first node of a cluster running <strong>Harvester v1.3.0 with RKE2 v1.27.10+rke2r1</strong>.</p><ol><li>Rotate the token on initial node.</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/opt/rke2/bin $ ./rke2 token rotate --token rancher --new-token rancher1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Recommended to keep a record of the old token. If restoring from a snapshot, you must use the token associated with that snapshot.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARN[0000] Cluster CA certificate is not trusted by the host CA bundle, but the token does not include a CA hash. Use the full token from the server&#x27;s node-token file to enable Cluster CA validation. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Token rotated, restart rke2 nodes with new token</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="2"><li>When the first cluster node was rebooted, RKE2 service was unable to start.</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">RKE2 log:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">May 29 15:45:11 harv41 rke2[3293]: time=&quot;2024-05-29T15:45:11Z&quot; level=info msg=&quot;etcd temporary data store connection OK&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">May 29 15:45:11 harv41 rke2[3293]: time=&quot;2024-05-29T15:45:11Z&quot; level=info msg=&quot;Reconciling bootstrap data between datastore and disk&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">May 29 15:45:11 harv41 rke2[3293]: time=&quot;2024-05-29T15:45:11Z&quot; level=fatal msg=&quot;Failed to reconcile with temporary etcd: bootstrap data already found and encrypted with different token&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">May 29 15:45:11 harv41 systemd[1]: rke2-server.service: Main process exited, code=exited, status=1/FAILURE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This known issue was logged on Github issue <a href="https://github.com/rancher/rke2/issues/6250" target="_blank" rel="noopener noreferrer">rke2 token rotate does not work as expected (v1.27.10+rke2r1)</a>.</p><p>:::Warning</p><p>Do not attempt to rotate the RKE2 token on your cluster before Harvester announces official support for this feature (even if the embedded RKE2 binary has the <code>token rotate</code> option).</p><p>:::</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="password-of-the-default-user-rancher">Password of the Default User <code>rancher</code><a class="hash-link" href="#password-of-the-default-user-rancher" title="Direct link to heading">​</a></h3><p>This process is node-specific. You must change the <a href="https://docs.harvesterhci.io/v1.2/install/update-harvester-configuration/#password-of-user-rancher" target="_blank" rel="noopener noreferrer">password of the default user</a> on each node even if the same password is used on all Harvester nodes.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ssh-keys">SSH keys<a class="hash-link" href="#ssh-keys" title="Direct link to heading">​</a></h3><p>You must log into a Harvester node using the default user account <code>rancher</code> to change the <a href="https://docs.harvesterhci.io/v1.2/install/update-harvester-configuration#ssh-keys-of-user-rancher" target="_blank" rel="noopener noreferrer">SSH keys</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-proxy">HTTP Proxy<a class="hash-link" href="#http-proxy" title="Direct link to heading">​</a></h3><p>After a Harvester cluster is installed, you can use the Harvester UI to change the <a href="https://docs.harvesterhci.io/v1.2/advanced/index#http-proxy" target="_blank" rel="noopener noreferrer">HTTP proxy</a>.</p><p>Alternatively, you can use <code>kubectl</code> or the rest API against the URI <code>/harvesterhci.io.setting/http-proxy</code>.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get settings.harvesterhci.io http-proxy -oyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: harvesterhci.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default: &#x27;{}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Setting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: &quot;2024-05-13T20:44:20Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  generation: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: http-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resourceVersion: &quot;5914&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uid: 282506bb-f1dd-4247-bf0e-93640698c1f5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">status: {}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Harvester has a webhook that checks this setting to ensure it meets all conditions, e.g. the internal IPs and CIDRs are specified in the <code>noProxy</code> field.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Avoid changing the HTTP proxy from files in the host <code>/oem</code> path for the following reasons:</p><ul><li><p>You must manually change the HTTP proxy on each node.</p></li><li><p>Contents of local files are not automatically populated to new nodes.</p></li><li><p>Without help from the webhook, some erroneous configurations may not be promptly detected (see <a href="https://github.com/harvester/harvester/pull/5824" target="_blank" rel="noopener noreferrer">Node IP should be in noProxy</a>).</p></li><li><p>Harvester may change the file naming or content structure in the future.</p></li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="other-credentials-and-settings">Other Credentials and Settings<a class="hash-link" href="#other-credentials-and-settings" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="auto-rotate-rke2-certs"><code>auto-rotate-rke2-certs</code><a class="hash-link" href="#auto-rotate-rke2-certs" title="Direct link to heading">​</a></h3><p>Harvester is built on top of Kubernetes, RKE2, and Rancher. RKE2 generates a list of <code>*.crt</code> and <code>*.key</code> files that allow Kubernetes components to function. The <code>*.crt</code> file expires after one year by default.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ls /var/lib/rancher/rke2/server/tls/ -alth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root  570 May 27 08:45 server-ca.nochain.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- 1 root root 1.7K May 27 08:45 service.current.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root  574 May 27 08:45 client-ca.nochain.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root 4.0K May 13 20:45 kube-controller-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root 4.0K May 13 20:45 kube-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwx------ 6 root root 4.0K May 13 20:45 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwx------ 8 root root 4.0K May 13 20:45 ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 3.9K May 13 20:40 dynamic-cert.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwx------ 2 root root 4.0K May 13 20:39 temporary-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- 1 root root 1.7K May 13 20:39 service.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 1.2K May 13 20:39 client-auth-proxy.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- 1 root root  227 May 13 20:39 client-auth-proxy.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 1.2K May 13 20:39 client-rke2-cloud-controller.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 1.2K May 13 20:39 client-admin.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- 1 root root  227 May 13 20:39 client-admin.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ openssl x509 -enddate -noout -in /var/lib/rancher/rke2/server/tls/client-admin.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notAfter=May 13 20:39:42 2025 GMT</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>When a cluster has been running for over one year, Kubernetes components may fail to start after upgrades or node rebooting. The <a href="https://github.com/harvester/harvester/issues/3863#issuecomment-1539681311" target="_blank" rel="noopener noreferrer">workaround</a> is to delete the related files and restart the pod.</p><p>Harvester v1.3.0 added the setting <a href="https://docs.harvesterhci.io/v1.3/advanced/index#auto-rotate-rke2-certs" target="_blank" rel="noopener noreferrer"><code>auto-rotate-rke2-certs</code></a>, which allows you to set the Harvester cluster to automatically rotate certificates for RKE2 services. When you enable the setting and specify a certificate validity period, Harvester automatically replaces the certificate before the specified period ends.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Enabling this setting on your cluster is highly recommended.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="harvester-cloud-credentials">Harvester Cloud Credentials<a class="hash-link" href="#harvester-cloud-credentials" title="Direct link to heading">​</a></h3><p>See the article <a href="https://harvesterhci.io/kb/renew_harvester_cloud_credentials" target="_blank" rel="noopener noreferrer">Renew Harvester Cloud Credentials</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="additional-ca"><code>additional-ca</code><a class="hash-link" href="#additional-ca" title="Direct link to heading">​</a></h3><p>See the <a href="https://docs.harvesterhci.io/v1.2/advanced/index#additional-ca" target="_blank" rel="noopener noreferrer">documentation</a> for this setting.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ssl-certificates"><code>ssl-certificates</code><a class="hash-link" href="#ssl-certificates" title="Direct link to heading">​</a></h3><p>See the <a href="https://docs.harvesterhci.io/v1.2/advanced/index#ssl-certificates" target="_blank" rel="noopener noreferrer">documentation</a> for this setting.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ssl-parameters"><code>ssl-parameters</code><a class="hash-link" href="#ssl-parameters" title="Direct link to heading">​</a></h3><p>See the <a href="https://docs.harvesterhci.io/v1.2/advanced/index#ssl-parameters" target="_blank" rel="noopener noreferrer">documentation</a> for this setting.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="containerd-registry"><code>containerd-registry</code><a class="hash-link" href="#containerd-registry" title="Direct link to heading">​</a></h3><p>See the <a href="https://docs.harvesterhci.io/v1.2/advanced/index#containerd-registry" target="_blank" rel="noopener noreferrer">documentation</a> for this setting.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/security">security</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/credential">credential</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Best Practices for Harvester Security" href="/kb/harvester_security_best_practices"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/renew_harvester_cloud_credentials">Renew Harvester Cloud Credentials</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-05-17T00:00:00.000Z" itemprop="datePublished">May 17, 2024</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/ibrokethecloud" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/ibrokethecloud.png" alt="Gaurav Mehta"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ibrokethecloud" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Gaurav Mehta</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/m-ildefons" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/m-ildefons.png" alt="Moritz Röhrich"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/m-ildefons" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Moritz Röhrich</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Quality Assurance Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="expiration-of-kubeconfig-tokens-in-rancher-28x">Expiration of kubeconfig Tokens in Rancher 2.8.x<a class="hash-link" href="#expiration-of-kubeconfig-tokens-in-rancher-28x" title="Direct link to heading">​</a></h2><p>In Rancher 2.8.x, the default value of the <a href="https://ranchermanager.docs.rancher.com/api/api-tokens#kubeconfig-default-token-ttl-minutes" target="_blank" rel="noopener noreferrer">kubeconfig-default-token-ttl-minutes</a> setting is <code>30</code> days.</p><p>A side effect of using this default value is the expiration of authentication tokens embedded in kubeconfigs that Rancher uses to provision guest Kubernetes clusters on Harvester. When such tokens expire, Rancher loses the ability to perform management operations for the corresponding Rancher-managed guest Kubernetes clusters. <a href="https://github.com/rancher/rancher/issues/44912" target="_blank" rel="noopener noreferrer">Issue #44912</a> tracks the issue described in this article.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The issue affects only guest Kubernetes clusters running on Harvester that use cloud credentials created after installing or upgrading to Rancher v2.8.x.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="workaround">Workaround<a class="hash-link" href="#workaround" title="Direct link to heading">​</a></h2><p>You can patch the expired Harvester cloud credentials to use a new authentication token.</p><ol><li><p>Identify the expired cloud credentials and which Harvester cluster is
affected by them.</p><p><img loading="lazy" alt="identify-credentials" src="/assets/images/identify-cloud-credential-96a0eea63d2ff91994343792fff4065f.png" width="2231" height="980"></p></li><li><p>Download a new kubeconfig file for the affected Harvester cluster.</p><p><img loading="lazy" alt="context-menu" src="/assets/images/harvester-renew-kubeconfig-menu-988dc9a3898df89b96f1933a2455a0da.png" width="2037" height="945"></p></li><li><p>Patch the cloud credentials. The cloud credential is stored as a secret in <code>cattle-global-data</code> namespace, and can be replaced with the new kubeconfig file. Ensure that the environment variable <code>KUBECONFIG_FILE</code> contains the path to the new kubeconfig file.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">CLOUD_CREDENTIAL_ID</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$1</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># .metadata.name of the cloud credential</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG_FILE</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$2</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># path to the downloaded kubeconfig file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">kubeconfig</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">base64 -w </span><span class="token string variable number" style="color:#36acaa">0</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable string" style="color:#e3116c">&quot;</span><span class="token string variable string variable" style="color:#36acaa">${KUBECONFIG_FILE}</span><span class="token string variable string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">patch_file</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">mktemp</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${patch_file}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  harvestercredentialConfig-kubeconfigContent: </span><span class="token string variable" style="color:#36acaa">$kubeconfig</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl patch secret </span><span class="token variable" style="color:#36acaa">${CLOUD_CREDENTIAL_ID}</span><span class="token plain"> -n cattle-global-data --patch-file </span><span class="token variable" style="color:#36acaa">${patch_file}</span><span class="token plain"> --type merge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${patch_file}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>macOS users must use <code>gbase64</code> to ensure that the <code>-w</code> flag is supported.</p></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="expiration-of-kubeconfig-tokens-in-rancher-293">Expiration of kubeconfig Tokens in Rancher 2.9.3<a class="hash-link" href="#expiration-of-kubeconfig-tokens-in-rancher-293" title="Direct link to heading">​</a></h2><p>In Rancher 2.9.3 and later versions, the Rancher UI displays a warning when a Harvester cloud credential or a related cluster contains an expired token. You can renew the token on the <strong>Cloud Credentials</strong> screen by selecting <strong>⋮ &gt; Renew</strong>, or the Clusters screen by selecting <strong>⋮ &gt; Renew Cloud Credential</strong></p><p><img loading="lazy" alt="cc-renew" src="/assets/images/cc-renew-b94bcdd9ea16e36ced4101021ed3bacb.png" width="1481" height="444"></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>When you upgrade Rancher, the Rancher UI does not display a warning for Harvester cloud credentials that expired before the upgrade was started. However, you can still renew the token on the <strong>Cloud Credentials</strong> or <strong>Clusters</strong> screen.</p></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/cloud-credentials">cloud credentials</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/rancher">rancher</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Renew Harvester Cloud Credentials" href="/kb/renew_harvester_cloud_credentials"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/install_iscsi_firmware_install_boot">Configuring Harvester to Boot from an iSCSI Root Disk in Special Circumstances</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-03-05T00:00:00.000Z" itemprop="datePublished">March 5, 2024</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Jeff Radick</span></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Through v1.3.0, no explicit support has been provided for using Harvester (installing, booting, and running) with any type of storage that is not locally attached. This is in keeping with the philosophy of Hyper-Converged Infrastructure (HCI), which by definition hosts computational capability, storage, and networking in a single device or a set of similar devices operating in a cluster.</p><p>However, there are certain limited conditions that allow Harvester to be used on nodes without locally-attached bootable storage devices. Specifically, the use of converged network adapters (CNAs) as well as manual changes to the boot loader configuration of the installed system are required.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="concepts-requirements-and-limitations">Concepts, Requirements, and Limitations<a class="hash-link" href="#concepts-requirements-and-limitations" title="Direct link to heading">​</a></h2><p>This section describes background concepts and outlines requirements and limitations that you must consider before performing the procedure. For more information about the described concepts, see the references listed at the end of this article.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="iscsi-concepts-and-terminology">iSCSI Concepts and Terminology<a class="hash-link" href="#iscsi-concepts-and-terminology" title="Direct link to heading">​</a></h3><p>SCSI (Small Computer System Interface) is a set of standards for transferring data between computers systems and I/O devices. It is primarily used with storage devices.</p><p>The SCSI standards specify the following:</p><ul><li><strong>SCSI protocol</strong>: A set of message formats and rules of exchange</li><li><strong>SCSI transports</strong>: Methods for physically connecting storage devices to the computer system and transferring SCSI messages between them</li></ul><p>A number of SCSI transports are defined, including the following:</p><ul><li><strong>SAS (Serial Attached SCSI)</strong> and <strong>UAS (USB Attached SCSI)</strong>: Used to access SCSI storage devices that are directly attached to the computers using that storage</li><li><strong>FCP (Fibre Channel Protocol)</strong> and <strong>iSCSI (Internet SCSI)</strong>: Permit computer systems to access storage via a Storage Area Network (SAN), where the storage devices are attached to a system other than the computers using that storage</li></ul><p>The SCSI protocol is a client-server protocol, which means that all interaction occurs between clients that send requests and a server that services the requests. In the SCSI context, the client is called the <strong>initiator</strong> and the server is called the <strong>target</strong>. iSCSI initiators and targets identify themselves using a specially formatted identifier called an <strong>iSCSI qualified name (IQN)</strong>. The controller used to provide access to the storage devices is commonly called a <strong>host bus adapter (HBA)</strong>.</p><p>When using iSCSI, access is provided by a traditional Internet protocol, with an extra layer to encapsulate SCSI commands within TCP/IP messages. This can be implemented entirely in software (transferring messages using a traditional NIC), or it can be &quot;offloaded&quot; to a &quot;smart&quot; NIC that contains the iSCSI protocol and provides access through special firmware. Such NICs, which provide both a traditional Ethernet interface for regular Internet traffic and a higher-level storage interface for iSCSI services, are often called <strong>converged network adapters (CNAs)</strong>.</p><p>Systems with iSCSI CNAs can be configured to enable the system bootstrap firmware to boot the system via iSCSI. In addition, if the loaded operating system is aware of such an interface provided by the CNA, it can access the bootstrap device using that firmware interface <em>as if it were a locally attached device</em> without requiring initialization of the operating system&#x27;s full software iSCSI protocol machinery.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="additional-concepts-and-terminology">Additional Concepts and Terminology<a class="hash-link" href="#additional-concepts-and-terminology" title="Direct link to heading">​</a></h3><p>Harvester must be installed on a bootable storage device, which is referred to as the <em>boot disk</em>.</p><p>Other storage devices, which are referred to as <em>non-boot disks</em>, may also be used in the Harvester ecosystem.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">​</a></h3><p>You must install Harvester on a node with a converged NIC that provides iSCSI offload capability with firmware support. This firmware must specifically support the iSCSI Boot Firmware Table (iBFT).</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The procedure was tested with the following:</p><ul><li>Harvester v1.2.1 and v1.3.0</li><li>Dell PowerEdge R650 (Other systems with comparable hardware and firmware iSCSI support may also be suitable.)</li></ul></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="limitations">Limitations<a class="hash-link" href="#limitations" title="Direct link to heading">​</a></h3><p>The procedure will not work in environments with the following conditions:</p><ul><li>iSCSI is not implemented in a converged NIC.</li><li>Nodes boot via PXE.</li><li>Harvester is installed only on virtual machines.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="procedure">Procedure<a class="hash-link" href="#procedure" title="Direct link to heading">​</a></h2><p>The following is a summary of the procedure. Individual steps, which are described in the following sections, must be performed interactively. A fully automated installation is <strong>not</strong> possible at this time.</p><ol><li>Provision storage for your Harvester node on your iSCSI server system.</li><li>Configure system firmware to boot via iSCSI using the available CNA.</li><li>Boot the Harvester install image and install to the iSCSI device.</li><li>On first Harvester boot after installation, edit the kernel boot parameters in the GRUB kernel command line.</li><li>Permanently edit the GRUB configuration file in the normally read-only partition.</li></ol><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>The boot configuration changes will persist across node reboots but <strong>not</strong> across system upgrades, which will overwrite the GRUB parameters. </p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-provision-storage-for-your-harvester-node-on-your-iscsi-server-system">1. Provision storage for your Harvester node on your iSCSI server system.<a class="hash-link" href="#1-provision-storage-for-your-harvester-node-on-your-iscsi-server-system" title="Direct link to heading">​</a></h3><p>Before attempting to install Harvester onto a disk accessed by iSCSI,
the storage must first be provisioned on the storage server.</p><p>The details depend on the storage server and will not be discussed here.</p><p>However, several pieces of information must be obtained
in order for the system being installed to be able
to access the storage using iSCSI.</p><ul><li>The IP address and port number of the iSCSI server.</li><li>The iSCSI Qualified Name (IQN) of the iSCSI target on the server.</li><li>The LUN of the volume on the server to be accessed from the client as the disk on which Harvester will be installed.</li><li>Depending on on how the server is administered, authentication parameters may also be required.</li></ul><p>These items of information will be determined by the server system.</p><p>In addition, an IQN must be chosen for the client system to be used as its initiator identifier.</p><p>An IQN is a string in a certain format.
In general, any string in the defined format can be used as long as it is unique.
However, specific environments may place stricter requirements on the choice of names.</p><p>The format of an IQN is illustrated in the following example:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    iqn.2024-02.com.example:cluster1-node0-boot-disk</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There are lots of variations of this format, and this is just an example.</p><p>The correct name to use should be chosen in consultation with the administrator of your storage server and storage area network.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-configure-system-firmware-to-boot-via-iscsi-using-the-available-cna">2. Configure system firmware to boot via iSCSI using the available CNA.<a class="hash-link" href="#2-configure-system-firmware-to-boot-via-iscsi-using-the-available-cna" title="Direct link to heading">​</a></h3><p>When your system to be installed powers on or is reset, you must enter the firmware setup menu to change the boot settings and enable booting via iSCSI.</p><p>Precise details for this are difficult to provide because they vary from system to system.</p><p>It is typical to force the system to enter the firmware settings menu by typing a special key such as F2, F7, ESC, etc.
Which one works for your system varies.
Often the system will display a list of which key(s) are available for specific firmware functions,
but it is not uncommon for the firmware to erase this list and start to boot after only a very short delay,
so you have to pay close attention.</p><p>If in doubt, consult the system provider&#x27;s documentation.
An example document link is provided in the References section.
Other vendors should provide similar documentation.</p><p>The typical things you need to configure are:</p><ul><li>Enable UEFI boot</li><li>Configure iSCSI initiator and target parameters</li><li>Enable the iSCSI device in the boot menu</li><li>Set the boot order so that your system will boot from the iSCSI device</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="boot-the-harvester-install-image-and-install-to-the-iscsi-device">Boot the Harvester install image and install to the iSCSI device<a class="hash-link" href="#boot-the-harvester-install-image-and-install-to-the-iscsi-device" title="Direct link to heading">​</a></h3><p>This can be done by whatever means you would normally use to load the Harvester install image.</p><p>The Harvester installer <em>should</em> automatically &quot;see&quot; the iSCSI device in the dialog where you chose the installation destination.
Choose this device to install.</p><p>Installation should proceed and complete normally.</p><p>When installation completes, your system should reboot.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-on-first-boot-edit-kernel-boot-parameters-in-the-grub-kernel-command-line">4. On first boot, edit kernel boot parameters in the GRUB kernel command line.<a class="hash-link" href="#4-on-first-boot-edit-kernel-boot-parameters-in-the-grub-kernel-command-line" title="Direct link to heading">​</a></h3><p>As your system starts to come up after the first reboot,
the firmware will load the boot loader (GRUB) from the iSCSI device,
and GRUB will be able to use this device to load the kernel.</p><p>However, the kernel will <strong>not</strong> be aware of the iSCSI boot disk <strong>unless</strong> you modify the kernel parameters in the GRUB command line.</p><p>If you don&#x27;t modify the kernel parameters, then system startup procedures will fail to find the <code>COS_OEM</code> and other paritions on the boot disk,
and it will be unable to access the <code>cloud-init</code> configuration or any of the container images needed to </p><p>The first time the GRUB menu appears after installation, you should stop the GRUB boot loader from automatically loading the kernel,
and edit the kernel command line.</p><p>To stop GRUB from automatically loading the kernel, hit the ESC key as soon as the menu appears.
You will only have a few seconds to do this before the system automatically boots.</p><p>Then, type &quot;e&quot; to edit the GRUB configuration for the first boot option.</p><p>It will show you something similar to the following:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">setparams &#x27;Harvester v1.3.0&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # label is kept around for backward compatibility</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  set label=${active_label}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  set img=/cOS/active.img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loopback $loopdev /$img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source $(loopdev)/etc/cos/bootargs.cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  linux ($loopdev)$kernel $kernelcmd ${extra_cmdline} ${extra_active_cmdline}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  initrd ($loopdev)$initramfs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Move the cursor down to the line that begins with <code>linux</code>, and move the cursor to the end of that line.</p><p>Append the following string (two parameters): <code>rd.iscsi.firmware rd.iscsi.ibft</code>.</p><p>The line beginning with <code>linux</code> should now look like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">  linux ($loopdev)$kernel $kernelcmd ${extra_cmdline} ${extra_active_cmdline} rd.iscsi.firmware rd.iscsi.ibft</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>At this point, type Ctrl-X to resume booting with the modified kernel command line.</p><p>Now the node should come up normally, and finish with the normal Harvester console screen that shows the cluster and node IP addresses and status.</p><p>The the node should operate normally now <strong>but</strong> the kernel boot argument changes will not be preserved across a reboot unless you perform the next step.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-permanently-edit-the-grub-configuration-file">5. Permanently edit the GRUB configuration file.<a class="hash-link" href="#5-permanently-edit-the-grub-configuration-file" title="Direct link to heading">​</a></h3><p>At this point you need to preserve these boot argument changes.</p><p>You can do this from the console by pressing F12 and logging in, or you can use an SSH session over the network.</p><p>The changes must be made permanent by editing the GRUB configuration file <code>grub.cfg</code>.</p><p>The trick here is that the file to be changed is stored in a partition which is normally <strong>read-only</strong>,
so the first thing you must do is to re-mount the volume to be read-write.</p><p>Start out by using the <code>blkid</code> command to find the device name of the correct partition:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    $ sudo -i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # blkid -L COS_STATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /dev/sda4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The device name will be something like <code>/dev/sda4</code>.  The following examples assume that&#x27;s the name but you should modify the commands to match what you see on your system.</p><p>Now, re-mount that volume to make it writable:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># mount -o remount -rw /dev/sda4 /run/initramfs/cos-state</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Next, edit the <code>grub.cfg</code> file.</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># vim /run/initramfs/cos-state/grub2/grub.cfg</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Look for <code>menuentry</code> directives.  There will be several of these; at least one as a fallback, and one for recovery.  You should apply the same change to all of them.</p><p>In each of these, edit the line beginning with <code>linux</code> just as you did for the interactive GRUB menu, appending <code> rd.iscsi.firmware rd.iscsi.ibft</code> to the arguments.</p><p>Then save the changes.</p><p>It is not necessary, but probably advisable to remount that volume again to return it to its read-only state:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># mount -o remount -ro /dev/sda4 /run/initramfs/cos-state</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>From this point on, these changes will persist across node reboots.</p><p>A few important notes:</p><ul><li>You must perform this same procedure for every node of your cluster that you are booting with iSCSI.</li><li>These changes will be overwritten by the upgrade procedure if you upgrade your cluster to a newer version of Harvester.  Therefore, if you do an upgrade, be sure to re-do the procedure to edit the <code>grub.cfg</code> on every node of your cluster that is booting by iSCSI.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">​</a></h2><ul><li><a href="https://en.wikipedia.org/wiki/SCSI" target="_blank" rel="noopener noreferrer">SCSI</a> provides an overview of SCSI and contains references to additional material.</li><li><a href="https://en.wikipedia.org/wiki/ISCSI" target="_blank" rel="noopener noreferrer">iSCSI</a> provides an overview of iSCSI and contains references to additional material.</li><li><a href="https://en.wikipedia.org/wiki/Converged_network_adapter" target="_blank" rel="noopener noreferrer">Converged Network Adapter</a> provides a summary of CNAs and references to additional material.</li><li><a href="https://docs.harvesterhci.io/v1.2/troubleshooting/os/#how-to-permanently-edit-kernel-parameters" target="_blank" rel="noopener noreferrer">Harvester Docuementation</a> provides a general description of how to permanently edit kernel parameters to be used when booting a Harvester node.</li><li><a href="https://www.dell.com/support/manuals/en-us/poweredge-r630/r630_om_pub/uefi-iscsi-settings?guid=guid-adc7d625-5c7b-469d-ba9c-4a2c704fcc49&amp;lang=en-us" target="_blank" rel="noopener noreferrer">Dell PowerEdge R630 Owner&#x27;s Manual</a> This is an example of relevant vendor documentation.  Other vendors such as HPE, IBM, Lenovo, etc should provide comparable documentation, though the details will vary.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Configuring Harvester to Boot from an iSCSI Root Disk in Special Circumstances" href="/kb/install_iscsi_firmware_install_boot"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/the_potential_risk_with_filesystem_trim">Mitigating filesystem trim Risk</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-01-30T00:00:00.000Z" itemprop="datePublished">January 30, 2024</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/Vicente-Cheng.png" alt="Vicente Cheng"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Vicente-Cheng" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Vicente Cheng</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Filesystem trim is a common way to release unused space in a filesystem. However, this operation is known to cause IO errors when used with Longhorn volumes that are rebuilding. For more information about the errors, see the following issues:</p><ul><li>Harvester: <a href="https://github.com/harvester/harvester/issues/4739" target="_blank" rel="noopener noreferrer">Issue 4793</a></li><li>Longhorn: <a href="https://github.com/longhorn/longhorn/issues/7103" target="_blank" rel="noopener noreferrer">Issue 7103</a></li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>Filesystem trim was introduced in Longhorn v1.4.0 because of <a href="https://github.com/longhorn/longhorn/issues/836" target="_blank" rel="noopener noreferrer">Issue 836</a>.</p><p>Longhorn volumes affected by the mentioned IO errors can disrupt operations in Harvester VMs that use those volumes. If you are using any of the affected Harvester versions, upgrade to a version with fixes or follow the instructions for risk mitigation in this article.</p><p><strong>Affected Harvester versions</strong>: v1.2.0 (uses Longhorn v1.4.3), v1.2.1 (uses Longhorn v1.4.3), and v1.3.0 (uses Longhorn v1.6.0)</p><p><strong>Harvester versions with fixes</strong>: v1.2.2 (uses Longhorn v1.5.5) and v1.3.1 (uses Longhorn v1.6.2)</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="risks-associated-with-filesystem-trim">Risks Associated with Filesystem Trim<a class="hash-link" href="#risks-associated-with-filesystem-trim" title="Direct link to heading">​</a></h2><p>A consequence of the IO errors caused by filesystem trim is that VMs using affected Longhorn volumes become stuck. Imagine the VM is running critical applications, then becomes unavailable. This is significant because Harvester typically uses Longhorn volumes as VM disks. The IO errors will cause VMs to flap between running and paused states until volume rebuilding is completed.</p><p>Although the described system behavior does not affect data integrity, it might induce panic in some users. Consider the guest Kubernetes cluster scenario. In a stuck VM, the etcd service is unavailable. The effects of this failure cascade from the Kubernetes cluster becoming unavailable to services running on the cluster becoming unavailable.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="how-to-check-if-filesystem-trim-is-enabled">How to Check If Filesystem Trim Is Enabled<a class="hash-link" href="#how-to-check-if-filesystem-trim-is-enabled" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="linux">Linux<a class="hash-link" href="#linux" title="Direct link to heading">​</a></h3><p>In most Linux distributions, filesystem trim is enabled by default. You can check if the related service fstrim is enabled by running the following command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl status fstrim.timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">● fstrim.timer - Discard unused blocks once a week</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Loaded: loaded (/lib/systemd/system/fstrim.timer; enabled; vendor preset: enabled)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Active: active (waiting) since Mon 2024-03-18 03:40:24 UTC; 1 week 1 day ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Trigger: Mon 2024-04-01 01:00:06 UTC; 5 days left</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Triggers: ● fstrim.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Docs: man:fstrim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mar 18 03:40:24 harvester-cluster-01-pool1-49b619f6-tpc4v systemd[1]: Started Discard unused blocks once a week.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>When the fstrim.timer service is enabled, the system periodically runs fstrim.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="windows">Windows<a class="hash-link" href="#windows" title="Direct link to heading">​</a></h3><p>You can check if filesystem trim is enabled by running the following command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; fsutil behavior query DisableDeleteNotify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NTFS DisableDeleteNotify = 0  (Allows TRIM operations to be sent to the storage device)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ReFS DisableDeleteNotify = 0  (Allows TRIM operations to be sent to the storage device)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>DisableDeleteNotify = 0</code> indicates that TRIM operations are enabled. For more information, see <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/fsutil-behavior" target="_blank" rel="noopener noreferrer">fsutil behavior</a> in the Microsoft documentation.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="risk-mitigation">Risk Mitigation<a class="hash-link" href="#risk-mitigation" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="linux-1">Linux<a class="hash-link" href="#linux-1" title="Direct link to heading">​</a></h3><p>One way to mitigate the described risks is to disable fstrim services in VMs. fstrim services is enabled by default in many modern Linux distributions.
You can determine if fstrim is enabled in VMs that use affected Longhorn volumes by checking the following:</p><ul><li><p><code>/etc/fstab</code>: Some root filesystems mount with the <em>discard</em> option.</p><p>Example:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/dev/mapper/rootvg-rootlv /                       xfs     defaults,discard        0 0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can disable fstrim on the root filesystem by removing the <em>discard</em> option.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/dev/mapper/rootvg-rootlv /                       xfs     defaults        0 0   &lt;-- remove the discard option</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After removing the <em>discard</em> option, you can remount the root filesystem using the command <code>mount -o remount /</code> or by rebooting the VM.</p></li><li><p><code>fstrim.timer</code>: When this service is enabled, fstrim executes weekly by default. You can either disable the service or edit the service file to prevent simultaneous fstrim execution on VMs.</p><p>You can disable the service using the following command:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl disable fstrim.timer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To prevent simultaneous fstrim execution, use the following values in the service file (located at <code>/usr/lib/systemd/system/fstrim.timer</code>):</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[Timer]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OnCalendar=weekly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AccuracySec=1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Persistent=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RandomizedDelaySec=6000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="windows-1">Windows<a class="hash-link" href="#windows-1" title="Direct link to heading">​</a></h3><p>To mitigate the described risks, you can disable TRIM operations using the following commands:</p><ul><li><p>ReFS v2</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; fsutil behavior set DisableDeleteNotify ReFS 1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>NTFS and ReFS v1</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; fsutil behavior set DisableDeleteNotify 1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/rancher-integration">rancher integration</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/filesystem-trim">filesystem trim</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Mitigating filesystem trim Risk" href="/kb/the_potential_risk_with_filesystem_trim"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/calculation_of_resource_metrics_in_harvester">Calculation of Resource Metrics in Harvester</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2024-01-23T00:00:00.000Z" itemprop="datePublished">January 23, 2024</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/w13915984028.png" alt="Jian Wang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jian Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Harvester calculates the resource metrics using data that is dynamically collected from the system. Host-level resource metrics are calculated and then aggregated to obtain the cluster-level metrics.</p><p>You can view resource-related metrics on the Harvester UI.</p><ul><li><p><strong>Hosts</strong> screen: Displays host-level metrics</p><p><img loading="lazy" alt="host level resources metrics" src="/assets/images/host-resource-usage-3f7d2c16335caae1ef42aa94f62a0dcb.png" width="3198" height="606"></p></li><li><p><strong>Dashboard</strong> screen: Displays cluster-level metrics</p><p><img loading="lazy" alt="cluster level resources metrics" src="/assets/images/cluster-resource-usage-6165985252a3fce5f61a11807124c423.png" width="3168" height="488"></p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="cpu-and-memory">CPU and Memory<a class="hash-link" href="#cpu-and-memory" title="Direct link to heading">​</a></h2><p>The following sections describe the data sources and calculation methods for CPU and memory resources.</p><ul><li>Resource capacity: Baseline data</li><li>Resource usage: Data source for the <strong>Used</strong> field on the <strong>Hosts</strong> screen</li><li>Resource reservation: Data source for the <strong>Reserved</strong> field on the <strong>Hosts</strong> screen</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="resource-capacity">Resource Capacity<a class="hash-link" href="#resource-capacity" title="Direct link to heading">​</a></h3><p>In Kubernetes, a <code>Node</code> object is created for each host.</p><p>The <code>.status.allocatable.cpu</code> and <code>.status.allocatable.memory</code> represent the available CPU and Memory resources of a host.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl get nodes -A -oyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-limits: &#x27;{&quot;cpu&quot;:&quot;12715m&quot;,&quot;devices.kubevirt.io/kvm&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/tun&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/vhost-net&quot;:&quot;1&quot;,&quot;memory&quot;:&quot;17104951040&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-requests: &#x27;{&quot;cpu&quot;:&quot;5657m&quot;,&quot;devices.kubevirt.io/kvm&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/tun&quot;:&quot;1&quot;,&quot;devices.kubevirt.io/vhost-net&quot;:&quot;1&quot;,&quot;ephemeral-storage&quot;:&quot;50M&quot;,&quot;memory&quot;:&quot;9155862208&quot;,&quot;pods&quot;:&quot;78&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node.alpha.kubernetes.io/ttl: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resourceVersion: &quot;2170215&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uid: b6f5850a-2fbc-4aef-8fbe-121dfb671b67</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    podCIDR: 10.52.0.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    podCIDRs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - 10.52.0.0/24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    providerID: rke2://harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addresses:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - address: 192.168.122.141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: InternalIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - address: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: Hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allocatable:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cpu: &quot;10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/kvm: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/tun: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/vhost-net: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ephemeral-storage: &quot;149527126718&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-1Gi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-2Mi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      memory: 20464216Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pods: &quot;200&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cpu: &quot;10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/kvm: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/tun: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      devices.kubevirt.io/vhost-net: 1k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ephemeral-storage: 153707984Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-1Gi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hugepages-2Mi: &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      memory: 20464216Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pods: &quot;200&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="resource-usage">Resource Usage<a class="hash-link" href="#resource-usage" title="Direct link to heading">​</a></h3><p>CPU and memory usage data is continuously collected and stored in the <code>NodeMetrics</code> object. Harvester reads the data from <code>usage.cpu</code> and <code>usage.memory</code>.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl get NodeMetrics -A -oyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiVersion: metrics.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: NodeMetrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timestamp: &quot;2024-01-23T12:04:44Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cpu: 891736742n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memory: 9845008Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  window: 10.149s</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="resource-reservation">Resource Reservation<a class="hash-link" href="#resource-reservation" title="Direct link to heading">​</a></h3><p>Harvester dynamically calculates the resource limits and requests of all pods running on a host, and updates the information to the annotations of the <code>NodeMetrics</code> object.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-limits: &#x27;{&quot;cpu&quot;:&quot;12715m&quot;,...,&quot;memory&quot;:&quot;17104951040&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      management.cattle.io/pod-requests: &#x27;{&quot;cpu&quot;:&quot;5657m&quot;,...,&quot;memory&quot;:&quot;9155862208&quot;}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For more information, see <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits" target="_blank" rel="noopener noreferrer">Requests and Limits</a> in the Kubernetes documentation.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="storage">Storage<a class="hash-link" href="#storage" title="Direct link to heading">​</a></h2><p>Longhorn is the default Container Storage Interface (CSI) driver of Harvester, providing storage management features such as distributed block storage and tiering.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="reserved-storage-in-longhorn">Reserved Storage in Longhorn<a class="hash-link" href="#reserved-storage-in-longhorn" title="Direct link to heading">​</a></h3><p>Longhorn allows you to specify the percentage of disk space that is not allocated to the default disk on each new Longhorn node. The default value is &quot;30&quot;. For more information, see <a href="https://longhorn.io/docs/1.5.3/references/settings/#storage-reserved-percentage-for-default-disk" target="_blank" rel="noopener noreferrer">Storage Reserved Percentage For Default Disk</a> in the Longhorn documentation.</p><p>Depending on the disk size, you can modify the default value using the <a href="https://docs.harvesterhci.io/v1.2/troubleshooting/harvester/#access-embedded-rancher-and-longhorn-dashboards" target="_blank" rel="noopener noreferrer">embedded Longhorn UI</a>.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Before changing the settings, read the Longhorn documentation carefully.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="data-sources-and-calculation">Data Sources and Calculation<a class="hash-link" href="#data-sources-and-calculation" title="Direct link to heading">​</a></h3><p>Harvester uses the following data to calculate metrics for storage resources.</p><ul><li><p>Sum of the <code>storageMaximum</code> values of all disks (<code>status.diskStatus.disk-name</code>): Total storage capacity</p></li><li><p>Total storage capacity - Sum of the <code>storageAvailable</code> values of all disks (<code>status.diskStatus.disk-name</code>): Data source for the <strong>Used</strong> field on the <strong>Hosts</strong> screen</p></li><li><p>Sum of the <code>storageReserved</code> values of all disks (<code>spec.disks</code>): Data source for the <strong>Reserved</strong> field on the <strong>Hosts</strong> screen</p></li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># kubectl get nodes.longhorn.io -n longhorn-system -oyaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- apiVersion: longhorn.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind: Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: harv41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace: longhorn-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowScheduling: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disks:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      default-disk-ef11a18c36b01132:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allowScheduling: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        diskType: filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        evictionRequested: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path: /var/lib/harvester/defaultdisk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageReserved: 24220101427</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tags: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    diskStatus:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      default-disk-ef11a18c36b01132:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        diskType: filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        diskUUID: d2788933-8817-44c6-b688-dee414cc1f73</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduledReplica:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-95561210-c39c-4c2e-ac9a-4a9bd72b3100-r-20affeca: 2147483648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-9e83b2dc-6a4b-4499-ba70-70dc25b2d9aa-r-4ad05c86: 32212254720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-bc25be1e-ca4e-4818-a16d-48353a0f2f96-r-c7b88c60: 3221225472</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-d9d3e54d-8d67-4740-861e-6373f670f1e4-r-f4c7c338: 2147483648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          pvc-e954b5fe-bbd7-4d44-9866-6ff6684d5708-r-ba6b87b6: 5368709120</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageAvailable: 77699481600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageMaximum:   80733671424</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storageScheduled: 45097156608</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    snapshotCheckStatus: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zone: &quot;&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/resource-metrics">resource metrics</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/reserved-resource">reserved resource</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/calculation">calculation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Calculation of Resource Metrics in Harvester" href="/kb/calculation_of_resource_metrics_in_harvester"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/best_practices_for_optimizing_longhorn_disk_performance">Best Practices for Optimizing Longhorn Disk Performance</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-12-27T00:00:00.000Z" itemprop="datePublished">December 27, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/innobead" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/innobead.png" alt="David Ko"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/innobead" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">David Ko</span></a></div><small class="avatar__subtitle" itemprop="description">Senior Software Engineering Manager</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/jillian-maroket/" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/jillian-maroket.png" alt="Jillian Maroket"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jillian-maroket/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jillian Maroket</span></a></div><small class="avatar__subtitle" itemprop="description">Technical Writer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>The Longhorn documentation provides <a href="https://longhorn.io/docs/1.6.0/best-practices/" target="_blank" rel="noopener noreferrer">best practice recommendations</a> for deploying Longhorn in production environments. Before configuring workloads, ensure that you have set up the following basic requirements for optimal disk performance.</p><ul><li>SATA/NVMe SSDs or disk drives with similar performance</li><li>10 Gbps network bandwidth between nodes</li><li>Dedicated Priority Classes for system-managed and user-deployed Longhorn components</li></ul><p>The following sections outline other recommendations for achieving optimal disk performance.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="io-performance">IO Performance<a class="hash-link" href="#io-performance" title="Direct link to heading">​</a></h2><ul><li><p><strong>Storage network</strong>: Use a <a href="https://docs.harvesterhci.io/v1.3/advanced/storagenetwork" target="_blank" rel="noopener noreferrer">dedicated storage network</a> to improve IO performance and stability.  </p></li><li><p><strong>Longhorn disk</strong>: Use a <a href="https://docs.harvesterhci.io/v1.3/host/#multi-disk-management" target="_blank" rel="noopener noreferrer">dedicated disk</a> for Longhorn storage instead of using the root disk.  </p></li><li><p><strong>Replica count</strong>: Set the <a href="https://docs.harvesterhci.io/v1.3/advanced/storageclass#parameters-tab" target="_blank" rel="noopener noreferrer">default replica count</a> to &quot;2&quot; to achieve data availability with better disk space usage or less impact to system performance. This practice is especially beneficial to data-intensive applications.  </p></li><li><p><strong>Storage tag</strong>: Use storage tags to define storage tiering for data-intensive applications. For example, only high-performance disks can be used for storing performance-sensitive data. You can either <a href="https://docs.harvesterhci.io/v1.3/host/#storage-tags" target="_blank" rel="noopener noreferrer">add disks with tags</a> or <a href="https://docs.harvesterhci.io/v1.3/advanced/storageclass#disk-selector-optional" target="_blank" rel="noopener noreferrer">create StorageClasses with tags</a>.  </p></li><li><p><strong>Data locality</strong>: Use <code>best-effort</code> as the default <a href="https://longhorn.io/docs/1.6.0/high-availability/data-locality/" target="_blank" rel="noopener noreferrer">data locality</a> of Longhorn Storage Classes.  </p><p>For applications that support data replication (for example, a distributed database), you can use the <code>strict-local</code> option to ensure that only one replica is created for each volume. This practice prevents the extra disk space usage and IO performance overhead associated with volume replication.  </p><p>For data-intensive applications, you can use pod scheduling functions such as node selector or taint toleration. These functions allow you to schedule the workload to a specific storage-tagged node together with one replica.  </p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="space-efficiency">Space Efficiency<a class="hash-link" href="#space-efficiency" title="Direct link to heading">​</a></h2><ul><li><p><strong>Recurring snapshots</strong>: Periodically clean up system-generated snapshots and retain only the number of snapshots that makes sense for your implementation. </p><p>For applications with replication capability, periodically <a href="https://longhorn.io/docs/1.6.0/concepts/#243-deleting-snapshots" target="_blank" rel="noopener noreferrer">delete all types of snapshots</a>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="disaster-recovery">Disaster Recovery<a class="hash-link" href="#disaster-recovery" title="Direct link to heading">​</a></h2><ul><li><p><strong>Recurring backups</strong>: Create <a href="https://longhorn.io/docs/1.6.0/snapshots-and-backups/scheduling-backups-and-snapshots/" target="_blank" rel="noopener noreferrer">recurring backup jobs</a> for mission-critical application volumes.</p></li><li><p><strong>System backup</strong>: Run periodic system backups.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/longhorn">longhorn</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/best-practices">best practices</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/disk-performance">disk performance</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Best Practices for Optimizing Longhorn Disk Performance" href="/kb/best_practices_for_optimizing_longhorn_disk_performance"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/vm_live_migration_policy_and_configuration">VM Live Migration Policy and Configuration</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-09-01T00:00:00.000Z" itemprop="datePublished">September 1, 2023</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/w13915984028.png" alt="Jian Wang"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/w13915984028" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jian Wang</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In Harvester, the <strong>VM Live Migration</strong> is well supported by the UI. Please refer to <a href="https://docs.harvesterhci.io/v1.1/vm/live-migration" target="_blank" rel="noopener noreferrer">Harvester VM Live Migration</a> for more details.</p><p>The VM Live Migration process is finished smoothly in most cases. However, sometimes the migration may get stuck and not end as expected.</p><p>This article dives into the VM Live Migration process in more detail. There are three main parts:</p><ul><li>General Process of VM Live Migration</li><li>VM Live Migration Strategies</li><li>VM Live Migration Configurations</li></ul><p>Related issues:</p><ul><li><a href="https://github.com/harvester/harvester/issues/4352" target="_blank" rel="noopener noreferrer">Migration should show the proper status and progress in the UI</a></li><li><a href="https://github.com/harvester/harvester/issues/4376" target="_blank" rel="noopener noreferrer">VM Migration policy and status</a></li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>A big part of the following contents are copied from <code>kubevirt</code> document <a href="https://kubevirt.io/user-guide/operations/live_migration/" target="_blank" rel="noopener noreferrer">https://kubevirt.io/user-guide/operations/live_migration/</a>, some contents/formats are adjusted to fit in this document.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="general-process-of-vm-live-migration">General Process of VM Live Migration<a class="hash-link" href="#general-process-of-vm-live-migration" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="starting-a-migration-from-harvester-ui">Starting a Migration from Harvester UI<a class="hash-link" href="#starting-a-migration-from-harvester-ui" title="Direct link to heading">​</a></h3><ol><li>Go to the <strong>Virtual Machines</strong> page.</li><li>Find the virtual machine that you want to migrate and select <strong>⋮</strong> &gt; <strong>Migrate</strong>.</li><li>Choose the node to which you want to migrate the virtual machine and select <strong>Apply</strong>.</li></ol><p>After successfully selecting <strong>Apply</strong>, a CRD <code>VirtualMachineInstanceMigration</code> object is created, and the related <code>controller/operator</code> will start the process.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-crd-object">Migration CRD Object<a class="hash-link" href="#migration-crd-object" title="Direct link to heading">​</a></h3><p>You can also create the CRD <code>VirtualMachineInstanceMigration</code> object manually via <code>kubectl</code> or other tools.</p><p>The example below starts a migration process for a virtual machine instance (VMI) <code>new-vm</code>.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubevirt.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: VirtualMachineInstanceMigration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: migration-job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vmiName: new-vm</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Under the hood, the open source projects <code>Kubevirt, Libvirt, QEMU, ... </code> perform most of the <code>VM Live Migration</code>. <a href="#references">References.</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-status-reporting">Migration Status Reporting<a class="hash-link" href="#migration-status-reporting" title="Direct link to heading">​</a></h3><p>When starting a virtual machine instance (VMI), it has also been calculated whether the machine is live migratable. The result is being stored in the VMI <code>VMI.status.conditions</code>. The calculation can be based on multiple parameters of the VMI, however, at the moment, the calculation is largely based on the Access Mode of the VMI volumes. Live migration is only permitted when the volume access mode is set to ReadWriteMany. Requests to migrate a non-LiveMigratable VMI will be rejected.</p><p>The reported Migration Method is also being calculated during VMI start. <code>BlockMigration</code> indicates that some of the VMI disks require copying from the source to the destination. <code>LiveMigration</code> means that only the instance memory will be copied.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Conditions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status: True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: LiveMigratable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Migration Method: BlockMigration</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-status">Migration Status<a class="hash-link" href="#migration-status" title="Direct link to heading">​</a></h3><p>The migration progress status is reported in <code>VMI.status</code>. Most importantly, it indicates whether the migration has been completed or failed.</p><p>Below is an example of a successful migration.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Migration State:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Completed:        true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    End Timestamp:    2019-03-29T03:37:52Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Migration Config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Completion Timeout Per GiB:  800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Progress Timeout:             150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Migration UID:                  c64d4898-51d3-11e9-b370-525500d15501</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source Node:                    node02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Start Timestamp:                2019-03-29T04:02:47Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Direct Migration Node Ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      35001:                      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      41068:                      49152</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      38284:                      49153</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Node:                  node01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Node Address:          10.128.0.46</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Node Domain Detected:  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Target Pod:                   virt-launcher-testvmimcbjgw6zrzcmp8wpddvztvzm7x2k6cjbdgktwv8tkq</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategies">VM Live Migration Strategies<a class="hash-link" href="#vm-live-migration-strategies" title="Direct link to heading">​</a></h2><p>VM Live Migration is a process during which a running Virtual Machine Instance moves to another compute node while the guest workload continues to run and remain accessible.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="understanding-different-vm-live-migration-strategies">Understanding Different VM Live Migration Strategies<a class="hash-link" href="#understanding-different-vm-live-migration-strategies" title="Direct link to heading">​</a></h3><p>VM Live Migration is a complex process. During a migration, the source VM needs to transfer its whole state (mainly RAM) to the target VM. If there are enough resources available, such as network bandwidth and CPU power, migrations should converge nicely. If this is not the scenario, however, the migration might get stuck without an ability to progress.</p><p>The main factor that affects migrations from the guest perspective is its dirty rate, which is the rate by which the VM dirties memory. Guests with high dirty rate lead to a race during migration. On the one hand, memory would be transferred continuously to the target, and on the other, the same memory would get dirty by the guest. On such scenarios, one could consider to use more advanced migration strategies. Refer to <a href="https://kubevirt.io/user-guide/operations/live_migration/#understanding-different-migration-strategies" target="_blank" rel="noopener noreferrer">Understanding different migration strategies</a> for more details.</p><p>There are 3 <code>VM Live Migration</code> strategies/policies:</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategy-pre-copy">VM Live Migration Strategy: Pre-copy<a class="hash-link" href="#vm-live-migration-strategy-pre-copy" title="Direct link to heading">​</a></h4><p>Pre-copy is the default strategy. It should be used for most cases.</p><p>The way it works is as following:</p><ol><li>The target VM is created, but the guest keeps running on the source VM.</li><li>The source starts sending chunks of VM state (mostly memory) to the target. This continues until all of the state has been transferred to the target.</li><li>The guest starts executing on the target VM. 4. The source VM is being removed.</li></ol><p>Pre-copy is the safest and fastest strategy for most cases. Furthermore, it can be easily cancelled, can utilize multithreading, and more. If there is no real reason to use another strategy, this is definitely the strategy to go with.</p><p>However, on some cases migrations might not converge easily, that is, by the time the chunk of source VM state would be received by the target VM, it would already be mutated by the source VM (which is the VM the guest executes on). There are many reasons for migrations to fail converging, such as a high dirty-rate or low resources like network bandwidth and CPU. On such scenarios, see the following alternative strategies below.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategy-post-copy">VM Live Migration Strategy: Post-copy<a class="hash-link" href="#vm-live-migration-strategy-post-copy" title="Direct link to heading">​</a></h4><p>The way post-copy migrations work is as following:</p><ol><li>The target VM is created.</li><li>The guest is being run on the target VM.</li><li>The source starts sending chunks of VM state (mostly memory) to the target.</li><li>When the guest, running on the target VM, would access memory: 1. If the memory exists on the target VM, the guest can access it. 2. Otherwise, the target VM asks for a chunk of memory from the source VM.</li><li>Once all of the memory state is updated at the target VM, the source VM is being removed.</li></ol><p>The main idea here is that the guest starts to run immediately on the target VM. This approach has advantages and disadvantages:</p><p><strong>Advantages:</strong></p><ul><li>The same memory chink is never being transferred twice. This is possible due to the fact that with post-copy it doesn&#x27;t matter that a page had been dirtied since the guest is already running on the target VM.</li><li>This means that a high dirty-rate has much less effect.</li><li>Consumes less network bandwidth.</li></ul><p><strong>Disadvantages:</strong></p><ul><li>When using post-copy, the VM state has no one source of truth. When the guest (running on the target VM) writes to memory, this memory is one part of the guest&#x27;s state, but some other parts of it may still be updated only at the source VM. This situation is generally dangerous, since, for example, if either the target or guest VMs crash the state cannot be recovered.</li><li>Slow warmup: when the guest starts executing, no memory is present at the target VM. Therefore, the guest would have to wait for a lot of memory in a short period of time.</li><li>Slower than pre-copy on most cases.</li><li>Harder to cancel a migration.</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-strategy-auto-converge">VM Live Migration Strategy: Auto-converge<a class="hash-link" href="#vm-live-migration-strategy-auto-converge" title="Direct link to heading">​</a></h4><p>Auto-converge is a technique to help pre-copy migrations converge faster without changing the core algorithm of how the migration works.</p><p>Since a high dirty-rate is usually the most significant factor for migrations to not converge, auto-converge simply throttles the guest&#x27;s CPU. If the migration would converge fast enough, the guest&#x27;s CPU would not be throttled or throttled negligibly. But, if the migration would not converge fast enough, the CPU would be throttled more and more as time goes.</p><p>This technique dramatically increases the probability of the migration converging eventually.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="observe-the-vm-live-migration-progress-and-result">Observe the VM Live Migration Progress and Result<a class="hash-link" href="#observe-the-vm-live-migration-progress-and-result" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="migration-timeouts">Migration Timeouts<a class="hash-link" href="#migration-timeouts" title="Direct link to heading">​</a></h4><p>Depending on the type, the live migration process will copy virtual machine memory pages and disk blocks to the destination. During this process non-locked pages and blocks are being copied and become free for the instance to use again. To achieve a successful migration, it is assumed that the instance will write to the free pages and blocks (pollute the pages) at a lower rate than these are being copied.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="completion-time">Completion Time<a class="hash-link" href="#completion-time" title="Direct link to heading">​</a></h4><p>In some cases the virtual machine can write to different memory pages / disk blocks at a higher rate than these can be copied, which will prevent the migration process from completing in a reasonable amount of time. In this case, live migration will be aborted if it is running for a long period of time. The timeout is calculated base on the size of the VMI, it&#x27;s memory and the ephemeral disks that are needed to be copied. The configurable parameter completionTimeoutPerGiB, which defaults to 800s is the time for GiB of data to wait for the migration to be completed before aborting it. A VMI with 8Gib of memory will time out after 6400 seconds.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="progress-timeout">Progress Timeout<a class="hash-link" href="#progress-timeout" title="Direct link to heading">​</a></h4><p>A VM Live Migration will also be aborted when it notices that copying memory doesn&#x27;t make any progress. The time to wait for live migration to make progress in transferring data is configurable by the <code>progressTimeout</code> parameter, which defaults to 150 seconds.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vm-live-migration-configurations">VM Live Migration Configurations<a class="hash-link" href="#vm-live-migration-configurations" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="changing-cluster-wide-migration-limits">Changing Cluster Wide Migration Limits<a class="hash-link" href="#changing-cluster-wide-migration-limits" title="Direct link to heading">​</a></h3><p>KubeVirt puts some limits in place so that migrations don&#x27;t overwhelm the cluster. By default, it is to only run 5 migrations in parallel with an additional limit of a maximum of 2 outbound migrations per node. Finally, every migration is limited to a bandwidth of 64MiB/s.</p><p>You can change these values in the <code>kubevirt</code> CR:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: kubevirt.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: Kubevirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: kubevirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      namespace: kubevirt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      configuration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        migrations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          parallelMigrationsPerCluster: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          parallelOutboundMigrationsPerNode: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          bandwidthPerMigration: 64Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          completionTimeoutPerGiB: 800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          progressTimeout: 150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          disableTLS: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          nodeDrainTaintKey: &quot;kubevirt.io/drain&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          allowAutoConverge: false ---------------------&gt; related to: Auto-converge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          allowPostCopy: false -------------------------&gt; related to: Post-copy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          unsafeMigrationOverride: false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Remember that most of these configurations can be overridden and fine-tuned to a specified group of VMs. For more information, please refer to the Migration Policies section below.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="migration-policies">Migration Policies<a class="hash-link" href="#migration-policies" title="Direct link to heading">​</a></h3><p><a href="https://kubevirt.io/user-guide/operations/migration_policies/" target="_blank" rel="noopener noreferrer">Migration policies</a> provides a new way of applying migration configurations to Virtual Machines. The policies can refine Kubevirt CR&#x27;s <code>MigrationConfiguration</code> that sets the cluster-wide migration configurations. This way, the cluster-wide settings default how the migration policy can be refined (i.e., changed, removed, or added).</p><p>Remember that migration policies are in version <code>v1alpha1</code>. This means that this API is not fully stable yet and that APIs may change in the future.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="migration-configurations">Migration Configurations<a class="hash-link" href="#migration-configurations" title="Direct link to heading">​</a></h4><p>Currently, the <code>MigrationPolicy</code> spec only includes the following configurations from Kubevirt CR&#x27;s <code>MigrationConfiguration</code>. (In the future, more configurations that aren&#x27;t part of Kubevirt CR will be added):</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: migrations.kubevirt.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: MigrationPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowAutoConverge: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bandwidthPerMigration: 217Ki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    completionTimeoutPerGiB: 23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowPostCopy: false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>All the above fields are optional. When omitted, the configuration will be applied as defined in KubevirtCR&#x27;s <code>MigrationConfiguration</code>. This way, KubevirtCR will serve as a configurable set of defaults for both VMs that are not bound to any <code>MigrationPolicy</code> and VMs that are bound to a <code>MigrationPolicy</code> that does not define all fields of the configurations.</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="matching-policies-to-vms">Matching Policies to VMs<a class="hash-link" href="#matching-policies-to-vms" title="Direct link to heading">​</a></h5><p>Next in the spec are the selectors defining the group of VMs to apply the policy. The options to do so are the following.</p><p>This policy applies to the VMs in namespaces that have all the required labels:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: migrations.kubevirt.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: MigrationPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespaceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      hpc-workloads: true       # Matches a key and a value</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The policy below applies to the VMs that have all the required labels:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: migrations.kubevirt.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: MigrationPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selectors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtualMachineInstanceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      workload-type: db       # Matches a key and a value</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="documents">Documents<a class="hash-link" href="#documents" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_mojV" id="libvirt-guest-migration">Libvirt Guest Migration<a class="hash-link" href="#libvirt-guest-migration" title="Direct link to heading">​</a></h3><p><code>Libvirt</code> has a chapter to describe the pricipal of <code>VM/Guest Live Migration</code>.</p><p><a href="https://libvirt.org/migration.html" target="_blank" rel="noopener noreferrer">https://libvirt.org/migration.html</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="kubevirt-live-migration">Kubevirt Live Migration<a class="hash-link" href="#kubevirt-live-migration" title="Direct link to heading">​</a></h3><p><a href="https://kubevirt.io/user-guide/operations/live_migration/" target="_blank" rel="noopener noreferrer">https://kubevirt.io/user-guide/operations/live_migration/</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="source-code">Source Code<a class="hash-link" href="#source-code" title="Direct link to heading">​</a></h3><p>The <code>VM Live Migration</code> related configuration options are passed to each layer correspondingly.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="kubevirt">Kubevirt<a class="hash-link" href="#kubevirt" title="Direct link to heading">​</a></h4><p><a href="https://github.com/kubevirt/kubevirt/blob/d425593ae392111dab80403ef0cde82625e37653/pkg/virt-launcher/virtwrap/live-migration-source.go#L103" target="_blank" rel="noopener noreferrer">https://github.com/kubevirt/kubevirt/blob/d425593ae392111dab80403ef0cde82625e37653/pkg/virt-launcher/virtwrap/live-migration-source.go#L103</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;libvirt.org/go/libvirt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func generateMigrationFlags(isBlockMigration, migratePaused bool, options *cmdclient.MigrationOptions) libvirt.DomainMigrateFlags {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if options.AllowAutoConverge {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        migrateFlags |= libvirt.MIGRATE_AUTO_CONVERGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if options.AllowPostCopy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        migrateFlags |= libvirt.MIGRATE_POSTCOPY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="go-package-libvirt">Go Package Libvirt<a class="hash-link" href="#go-package-libvirt" title="Direct link to heading">​</a></h4><p><a href="https://pkg.go.dev/libvirt.org/go/libvirt" target="_blank" rel="noopener noreferrer">https://pkg.go.dev/libvirt.org/go/libvirt</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">const (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MIGRATE_AUTO_CONVERGE                 = DomainMigrateFlags(C.VIR_MIGRATE_AUTO_CONVERGE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MIGRATE_RDMA_PIN_ALL                  = DomainMigrateFlags(C.VIR_MIGRATE_RDMA_PIN_ALL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MIGRATE_POSTCOPY                      = DomainMigrateFlags(C.VIR_MIGRATE_POSTCOPY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="libvirt">Libvirt<a class="hash-link" href="#libvirt" title="Direct link to heading">​</a></h4><p><a href="https://github.com/libvirt/libvirt/blob/bfe53e9145cd5996a791c5caff0686572b850f82/include/libvirt/libvirt-domain.h#L1030" target="_blank" rel="noopener noreferrer">https://github.com/libvirt/libvirt/blob/bfe53e9145cd5996a791c5caff0686572b850f82/include/libvirt/libvirt-domain.h#L1030</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    /* Enable algorithms that ensure a live migration will eventually converge.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This usually means the domain will be slowed down to make sure it does</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * not change its memory faster than a hypervisor can transfer the changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * memory to the destination host. VIR_MIGRATE_PARAM_AUTO_CONVERGE_*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * parameters can be used to tune the algorithm.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Since: 1.2.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VIR_MIGRATE_AUTO_CONVERGE = (1 &lt;&lt; 13),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /* Setting the VIR_MIGRATE_POSTCOPY flag tells libvirt to enable post-copy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * migration. However, the migration will start normally and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * virDomainMigrateStartPostCopy needs to be called to switch it into the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * post-copy mode. See virDomainMigrateStartPostCopy for more details.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Since: 1.3.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    VIR_MIGRATE_POSTCOPY = (1 &lt;&lt; 15),</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/virtual-machine">virtual machine</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/vm">VM</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/live-migration">live migration</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/policy">policy</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/strategy">strategy</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/configuration">configuration</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about VM Live Migration Policy and Configuration" href="/kb/vm_live_migration_policy_and_configuration"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/use_rook_ceph_external_storage">Use Rook Ceph External Storage with Harvester</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-08-23T00:00:00.000Z" itemprop="datePublished">August 23, 2023</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/futuretea" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/futuretea.png" alt="Hang Yu"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/futuretea" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Hang Yu</span></a></div><small class="avatar__subtitle" itemprop="description">Staff Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Starting with Harvester v1.2.0, it offers the capability to install a Container Storage Interface (CSI) in your Harvester cluster. This allows you to leverage external storage for the Virtual Machine&#x27;s non-system data disk, giving you the flexibility to use different drivers tailored for specific needs, whether it&#x27;s for performance optimization or seamless integration with your existing in-house storage solutions.</p><p>It&#x27;s important to note that, despite this enhancement, the provisioner for the Virtual Machine (VM) image in Harvester still relies on Longhorn. Prior to version 1.2.0, Harvester exclusively supported Longhorn for storing VM data and did not offer support for external storage as a destination for VM data.</p><p>One of the options for integrating external storage with Harvester is Rook, an open-source cloud-native storage orchestrator. Rook provides a robust platform, framework, and support for Ceph storage, enabling seamless integration with cloud-native environments.</p><p><a href="https://ceph.io" target="_blank" rel="noopener noreferrer">Ceph</a> is a software-defined distributed storage system that offers versatile storage capabilities, including file, block, and object storage. It is designed for large-scale production clusters and can be deployed effectively in such environments.</p><p><a href="https://rook.io" target="_blank" rel="noopener noreferrer">Rook</a> simplifies the deployment and management of Ceph, offering self-managing, self-scaling, and self-healing storage services. It leverages Kubernetes resources to automate the deployment, configuration, provisioning, scaling, upgrading, and monitoring of Ceph.</p><p>In this article, we will walk you through the process of installing, configuring, and utilizing <a href="https://rook.io/docs/rook/v1.12/Getting-Started/intro/" target="_blank" rel="noopener noreferrer">Rook</a> to use storage from an <a href="https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/" target="_blank" rel="noopener noreferrer">existing external Ceph cluster</a> as a data disk for a VM within the Harvester environment.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-harvester-cluster">Install Harvester Cluster<a class="hash-link" href="#install-harvester-cluster" title="Direct link to heading">​</a></h2><p>Harvester&#x27;s operating system follows an immutable design, meaning that most OS files revert to their pre-configured state after a reboot. To accommodate Rook Ceph&#x27;s requirements, you need to add specific persistent paths to the <code>os.persistentStatePaths</code> section in the <a href="https://docs.harvesterhci.io/dev/install/harvester-configuration#ospersistent_state_paths" target="_blank" rel="noopener noreferrer">Harvester configuration</a>. These paths include:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">os</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">persistent_state_paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/lib/rook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /var/lib/ceph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">modules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> rbd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nbd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After the cluster is installed, refer to <a href="https://docs.harvesterhci.io/v1.1/faq#how-can-i-access-the-kubeconfig-file-of-the-harvester-cluster" target="_blank" rel="noopener noreferrer">How can I access the kubeconfig file of the Harvester cluster?</a> to get the kubeconfig of the Harvester cluster.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-rook-to-harvester">Install Rook to Harvester<a class="hash-link" href="#install-rook-to-harvester" title="Direct link to heading">​</a></h2><p>Install Rook to the Harvester cluster by referring to <a href="https://rook.io/docs/rook/v1.12/Getting-Started/quickstart/" target="_blank" rel="noopener noreferrer">Rook Quickstart</a>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -fsSLo rook.tar.gz https://github.com/rook/rook/archive/refs/tags/v1.12.2.tar.gz </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -zxf rook.tar.gz </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> rook-1.12.2/deploy/examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># apply configurations ref: https://rook.github.io/docs/rook/v1.12/Getting-Started/example-configurations/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f crds.yaml -f common.yaml -f operator.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n rook-ceph </span><span class="token function" style="color:#d73a49">wait</span><span class="token plain"> --for</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Available deploy rook-ceph-operator --timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">10m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="using-an-existing-external-ceph-cluster">Using an existing external Ceph cluster<a class="hash-link" href="#using-an-existing-external-ceph-cluster" title="Direct link to heading">​</a></h2><ol><li>Run the python script <code>create-external-cluster-resources.py</code> in the <a href="https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/" target="_blank" rel="noopener noreferrer">existing external Ceph cluster</a> for creating all users and keys.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># script help ref: https://www.rook.io/docs/rook/v1.12/CRDs/Cluster/external-cluster/#1-create-all-users-and-keys</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -s https://raw.githubusercontent.com/rook/rook/v1.12.2/deploy/examples/create-external-cluster-resources.py </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> create-external-cluster-resources.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python3 create-external-cluster-resources.py --rbd-data-pool-name </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">pool_name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --namespace rook-ceph-external --format </span><span class="token function" style="color:#d73a49">bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="2"><li>Copy the Bash output.</li></ol><p>Example output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">export NAMESPACE=rook-ceph-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_FSID=b3b47828-4c60-11ee-be38-51902f85c805</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_USERNAME=client.healthchecker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_CEPH_MON_DATA=ceph-1=192.168.5.99:6789</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_USER_SECRET=AQDd6/dkFyu/IhAATv/uCMbHtWk4AYK2KXzBhQ==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ROOK_EXTERNAL_DASHBOARD_LINK=https://192.168.5.99:8443/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_NODE_SECRET=AQDd6/dk2HsjIxAA06Yw9UcOg0dfwV/9IFBRhA==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_NODE_SECRET_NAME=csi-rbd-node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_PROVISIONER_SECRET=AQDd6/dkEY1kIxAAAzrXZnVRf4x+wDUz1zyaQg==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export CSI_RBD_PROVISIONER_SECRET_NAME=csi-rbd-provisioner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MONITORING_ENDPOINT=192.168.5.99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export MONITORING_ENDPOINT_PORT=9283</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RBD_POOL_NAME=test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export RGW_POOL_PREFIX=default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="3"><li>Consume the external Ceph cluster resources on the Harvester cluster.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Paste the above output from create-external-cluster-resources.py into import-env.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> import-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> import-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># this script will create a StorageClass ceph-rbd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> import-external-cluster.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f common-external.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f cluster-external.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># wait for all pods to become Ready</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">watch</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;kubectl --namespace rook-ceph get pods&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="4"><li>Create the VolumeSnapshotClass <code>csi-rbdplugin-snapclass-external</code>.</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">./csi/rbd/snapshotclass-external.yaml </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: snapshot.storage.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: VolumeSnapshotClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: csi-rbdplugin-snapclass-external</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">driver: rook-ceph.rbd.csi.ceph.com # driver:namespace:operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  clusterID: rook-ceph-external # namespace:cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  csi.storage.k8s.io/snapshotter-secret-name: rook-csi-rbd-provisioner</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  csi.storage.k8s.io/snapshotter-secret-namespace: rook-ceph-external # namespace:cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">deletionPolicy: Delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ./csi/rbd/snapshotclass-external.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="configure-harvester-cluster">Configure Harvester Cluster<a class="hash-link" href="#configure-harvester-cluster" title="Direct link to heading">​</a></h2><p>Before you can make use of Harvester&#x27;s <strong>Backup &amp; Snapshot</strong> features, you need to set up some essential configurations through the Harvester <a href="https://docs.harvesterhci.io/v1.2/advanced/settings#csi-driver-config" target="_blank" rel="noopener noreferrer">csi-driver-config</a> setting. To set up these configurations, follow these steps:</p><ol><li>Login to the Harvester UI, then navigate to <strong>Advanced</strong> &gt; <strong>Settings</strong>.</li><li>Find and select <strong>csi-driver-config</strong>, and then click on the <strong>⋮</strong> &gt; <strong>Edit Setting</strong> to access the configuration options.</li><li>In the settings, set the <strong>Provisioner</strong> to <code>rook-ceph.rbd.csi.ceph.com</code>.</li><li>Next, specify the <strong>Volume Snapshot Class Name</strong> as <code>csi-rbdplugin-snapclass-external</code>. This setting points to the name of the <code>VolumeSnapshotClass</code> used for creating volume snapshots or VM snapshots.</li><li>Similarly, set the <strong>Backup Volume Snapshot Class Name</strong> to <code>csi-rbdplugin-snapclass-external</code>. This corresponds to the name of the <code>VolumeSnapshotClass</code> responsible for creating VM backups.</li></ol><p><img loading="lazy" alt="csi-driver-config-external" src="/assets/images/csi-driver-config-external-59b885aff7095a9bda897ed59f289d82.png" width="3824" height="1848"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="use-rook-ceph-in-harvester">Use Rook Ceph in Harvester<a class="hash-link" href="#use-rook-ceph-in-harvester" title="Direct link to heading">​</a></h2><p>After successfully configuring these settings, you can proceed to utilize the Rook Ceph StorageClass, which is named <code>rook-ceph-block</code> for the internal Ceph cluster or named <code>ceph-rbd</code> for the external Ceph cluster. You can apply this StorageClass when creating an empty volume or adding a new block volume to a VM, enhancing your Harvester cluster&#x27;s storage capabilities.</p><p>With these configurations in place, your Harvester cluster is ready to make the most of the Rook Ceph storage integration.</p><p><img loading="lazy" alt="rook-ceph-volume-external" src="/assets/images/rook-ceph-volume-external-974d73b9b863e95495c7b119d2c50954.png" width="3824" height="1848"></p><p><img loading="lazy" alt="rook-ceph-vm-external" src="/assets/images/rook-ceph-vm-external-4c1b4f6b6a6676e13d312cac3498d786.png" width="3824" height="1848"></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/rook">rook</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/ceph">ceph</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/csi">csi</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Use Rook Ceph External Storage with Harvester" href="/kb/use_rook_ceph_external_storage"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility">Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-08-21T00:00:00.000Z" itemprop="datePublished">August 21, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/yaocw2020" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://avatars.githubusercontent.com/u/7421463?s=400&amp;v=4" alt="Canwu Yao"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/yaocw2020" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Canwu Yao</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>As <strong>Harvester v1.2.0</strong> is released, a new Harvester cloud provider version <strong>0.2.2</strong> is integrated into RKE2 <strong>v1.24.15+rke2r1</strong>, <strong>v1.25.11+rke2r1</strong>,  <strong>v1.26.6+rke2r1</strong>, <strong>v1.27.3+rke2r1</strong>, and newer versions.</p><p>With Harvester v1.2.0, the new Harvester cloud provider offers enhanced load balancing capabilities for guest Kubernetes services. Specifically, it introduces the Harvester IP Pool feature, a built-in IP address management (IPAM) solution for the Harvester load balancer. It allows you to define an IP pool specific to a particular guest cluster by specifying the guest cluster name. For example, you can create an IP pool exclusively for the guest cluster named cluster2:</p><p><img loading="lazy" alt="image" src="/assets/images/ippoolforcluster2-264c61833ccd9a79fb03dd73930d2401.png" width="3050" height="972"></p><p>However, after upgrading, the feature is not automatically compatible with existing guest Kubernetes clusters, as they do not pass the correct cluster name to the Harvester cloud provider. Refer to <a href="https://github.com/harvester/harvester/issues/4232" target="_blank" rel="noopener noreferrer">issue 4232</a> for more details. Users can manually upgrade the Harvester cloud provider using Helm as a workaround and provide the correct cluster name after upgrading. However, this would result in a change in the load balancer IPs. </p><p>This article outlines a workaround that allows you to leverage the new IP pool feature while keeping the load balancer IPs unchanged.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h2><ul><li><p>Download the Harvester kubeconfig file from the Harvester UI. If you have imported Harvester into Rancher, do not use the kubeconfig file from the Rancher UI. Refer to <a href="https://docs.harvesterhci.io/v1.1/faq#how-can-i-access-the-kubeconfig-file-of-the-harvester-cluster" target="_blank" rel="noopener noreferrer">Access Harvester Cluster</a> to get the desired one.</p></li><li><p>Download the kubeconfig file for the guest Kubernetes cluster you plan to upgrade. Refer to <a href="https://ranchermanager.docs.rancher.com/how-to-guides/new-user-guides/manage-clusters/access-clusters/use-kubectl-and-kubeconfig#accessing-clusters-with-kubectl-from-your-workstation" target="_blank" rel="noopener noreferrer">Accessing Clusters with kubectl from Your Workstation</a> for instructions on how to download the kubeconfig file.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="steps-to-keep-load-balancer-ip">Steps to Keep Load Balancer IP<a class="hash-link" href="#steps-to-keep-load-balancer-ip" title="Direct link to heading">​</a></h2><ol><li><p>Execute the following script before upgrading.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://raw.githubusercontent.com/harvester/harvesterhci.io/main/kb/2023-08-21/keepip.sh | sh -s before_upgrade &lt;Harvester-kubeconfig-path&gt; &lt;guest-cluster-kubeconfig-path&gt; &lt;guest-cluster-name&gt; &lt;guest-cluster-nodes-namespace&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li><code>&lt;Harvester-kubeconfig-path&gt;</code>: Path to the Harvester kubeconfig file.</li><li><code>&lt;guest-cluster-kubeconfig-path&gt;</code>: Path to the kubeconfig file of your guest Kubernetes cluster.</li><li><code>&lt;guest-cluster-name&gt;</code>: Name of your guest cluster.</li><li><code>&lt;guest-cluster-nodes-namespace&gt;</code>: Namespace where the VMs of the guest cluster are located.</li></ul><p>The script will help users copy the DHCP information to the service annotation and modify the IP pool allocated history to make sure the IP is unchanged.</p><p><img loading="lazy" alt="image" src="/assets/images/before-upgrade-32da6d40ebe06324de4a258174ac6220.png" width="2196" height="780"></p><p>After executing the script, the load balancer service with DHCP mode will be annotated with the DHCP information. For example:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kube-vip.io/hwaddr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">6c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">4f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token datetime number" style="color:#36acaa">18:68</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kube-vip.io/requestedIP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 172.19.105.215</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>As for the load balancer service with pool mode, the IP pool allocated history will be modified as the new load balancer name. For example:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> loadbalancer.harvesterhci.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IPPool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">allocatedHistory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">192.168.100.2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default/cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">default</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lb1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ddc13071 </span><span class="token comment" style="color:#999988;font-style:italic"># replace the new load balancer name</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>Add network selector for the pool.</p><p>For example, the following cluster is under the VM network <code>default/mgmt-untagged</code>. The network selector should be <code>default/mgmt-untagged</code>.</p><p><img loading="lazy" alt="image" src="/assets/images/network-ba7294269bf230843a11803191e20f1e.png" width="3498" height="1980"></p><p><img loading="lazy" alt="image" src="/assets/images/network-selector-0f179a6c97e2fa3621bcaadd8c09e39d.png" width="3054" height="1232"></p></li><li><p>Upgrade the RKE2 cluster in the Rancher UI and select the new version.</p><p><img loading="lazy" alt="image" src="/assets/images/upgrade-6356d7891793f5c94e25da1f6aa22944.png" width="3502" height="2052"></p></li><li><p>Execute the script after upgrading.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl -sfL https://raw.githubusercontent.com/harvester/harvesterhci.io/main/kb/2023-08-21/keepip.sh | sh -s after_upgrade &lt;Harvester-kubeconfig-path&gt; &lt;guest-cluster-kubeconfig-path&gt; &lt;guest-cluster-name&gt; &lt;guest-cluster-nodes-namespace&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><img loading="lazy" alt="image" src="/assets/images/before-upgrade-32da6d40ebe06324de4a258174ac6220.png" width="2196" height="780"></p><p> In this step, the script wraps the operations to upgrade the Harvester cloud provider to set the cluster name. After the Harvester cloud provider is running, the new Harvester load balancers will be created with the unchanged IPs.</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/harvester">harvester</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/load-balancer">load balancer</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/cloud-provider">cloud provider</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/ip-pool">ip pool</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/kb/tags/upgrade">upgrade</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Upgrade Guest Kubernetes Clusters to be Compatible with Harvester IP Pools" href="/kb/upgrading_guest_clusters_with_harvester_ip_pool_compatibility"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kb/tags/harvester/page/2"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 harvesterhci.io</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0c08fa38.js"></script>
<script src="/assets/js/main.2aa1bfff.js"></script>
</body>
</html>